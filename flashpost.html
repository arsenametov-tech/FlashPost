<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashPost AI</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel –¥–ª—è JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Core -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Bebas+Neue&family=Caveat:wght@700&family=Lobster&family=Montserrat:wght@400;700;900&family=Oswald:wght@700&family=Pacifico&family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Montserrat', sans-serif; 
            background: #000; 
            color: white; 
            overflow: hidden; 
            height: 100vh;
        }
        
        #root {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–∑—ã—Ä—å–∫–æ–≤ */
        .bubbles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        
        .bubble-anim {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float-up linear infinite;
        }

        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        .font-comfortaa { font-family: 'Comfortaa', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .logo-spin { animation: logo-float 4s ease-in-out infinite; }
        @keyframes logo-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .glow-text {
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 0 30px rgba(255, 0, 255, 0.3);
        }

        input[type="range"] { -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); cursor: pointer;
            margin-top: -8px; border: 2px solid #ddd;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="bubbles-container" id="bubbles"></div>
    <div id="root"></div>

    <script>
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É–∑—ã—Ä—å–∫–æ–≤ —á–µ—Ä–µ–∑ JS –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
        const bubblesContainer = document.getElementById('bubbles');
        for(let i=0; i<20; i++) {
            const b = document.createElement('div');
            b.className = 'bubble-anim';
            const size = Math.random() * 60 + 20;
            b.style.width = `${size}px`;
            b.style.height = `${size}px`;
            b.style.left = `${Math.random() * 100}%`;
            b.style.animationDuration = `${Math.random() * 10 + 10}s`; // 10-20s duration
            b.style.animationDelay = `${Math.random() * 10}s`;
            bubblesContainer.appendChild(b);
        }
    </script>

    <script type="text/babel">
        /********************************************************************************
         * üîë API –ö–õ–Æ–ß
         ********************************************************************************/
        const HARDCODED_API_KEY = "AIzaSyAp0QUmuIRIjxl6lTMkKZK8FO8Hi2Cr1-U"; 
        /********************************************************************************/

        const { useState, useEffect, useRef, useCallback } = React;

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        const compressImage = (dataUrl, maxWidth = 1080, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ratio = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * ratio;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(dataUrl); // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            });
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconData = window.lucide?.icons?.[name] || 
                             window.lucide?.icons?.[name.toLowerCase()] ||
                             window.lucide?.icons?.[name.charAt(0).toLowerCase() + name.slice(1)];
            
            if (!iconData) return <div style={{ width: size, height: size }} className={className}></div>;

            const [tag, attrs, children] = iconData;
            const renderNodes = (nodes) => nodes.map(([childTag, childAttrs], idx) => {
                const Tag = childTag;
                return <Tag key={idx} {...childAttrs} />;
            });

            return (
                <svg {...attrs} width={size} height={size} className={className} strokeWidth={2} strokeLinecap="round" strokeLinejoin="round">
                    {renderNodes(children)}
                </svg>
            );
        };

        const FONTS = [
            { id: 'rounded', name: 'Magic Rounded', family: "'Comfortaa', cursive" },
            { id: 'serif', name: 'Classy Serif', family: "'Playfair Display', serif" },
            { id: 'strong', name: 'Strong Bold', family: "'Bebas Neue', sans-serif" },
            { id: 'cursive', name: 'Sweet Cursive', family: "'Pacifico', cursive" },
            { id: 'hand', name: 'Casual Hand', family: "'Caveat', cursive" },
            { id: 'retro', name: 'Retro Vibes', family: "'Lobster', cursive" },
            { id: 'modern', name: 'Modern Clean', family: "'Montserrat', sans-serif" },
            { id: 'impact', name: 'Bold Impact', family: "'Oswald', sans-serif" },
            { id: 'geometric', name: 'Geometric', family: "'Poppins', sans-serif" },
            { id: 'standard', name: 'Standard Sans', family: "sans-serif" }
        ];

        const HOOK_SUGGESTIONS = [
            "–ö–∞–∫ *—Å–æ–∑–¥–∞—Ç—å* –º–∞–≥–∏—é –∑–∞ 1 –º–∏–Ω—É—Ç—É?",
            "10 —Å–µ–∫—Ä–µ—Ç–æ–≤, –æ –∫–æ—Ç–æ—Ä—ã—Ö *–≤—Å–µ* –º–æ–ª—á–∞—Ç",
            "–ü–æ—á–µ–º—É —Ç–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç *–Ω–µ –∑–∞–ª–µ—Ç–∞–µ—Ç*?",
            "–•–≤–∞—Ç–∏—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å *—Ä–æ—Å—Ç*"
        ];

        const App = () => {
            const [step, setStep] = useState('input');
            const [rawText, setRawText] = useState('');
            const [userApiKey, setUserApiKey] = useState(HARDCODED_API_KEY || "");
            const [showSettings, setShowSettings] = useState(false);
            const [socials, setSocials] = useState({ instagram: '', telegram: '', newsletter: '' });
            const [isLlmLoading, setIsLlmLoading] = useState(false);
            const [aiIdeas, setAiIdeas] = useState([]);
            const [aiError, setAiError] = useState(null);
            
            // –î–∏–∑–∞–π–Ω –∏ –®–∞–±–ª–æ–Ω—ã
            const [design, setDesign] = useState({
                mainFont: FONTS[0],
                accentFont: FONTS[3], 
                textColor: '#ffffff', // –¶–≤–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                highlightColor: '#fcd34d', 
                overlayColor: '#000000', // –¶–≤–µ—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è/–æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è
                bgColor: '#0f172a',
                bgImage: null,
                bgOpacity: 0.6,
                textOpacity: 1.0,
                shadow: 'glow' 
            });
            const [savedTemplates, setSavedTemplates] = useState([]);
            const [showTemplatesModal, setShowTemplatesModal] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [templateError, setTemplateError] = useState(null);

            const [slides, setSlides] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const canvasRef = useRef(null);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (tg) {
                    tg.ready();
                    tg.expand();
                    if (tg.setHeaderColor) tg.setHeaderColor('#000000');
                    if (tg.setBackgroundColor) tg.setBackgroundColor('#000000');
                    tg.BackButton.onClick(() => {
                        setStep('input');
                        tg.BackButton.hide();
                    });
                }
                const loaded = localStorage.getItem('flashpost_templates');
                if (loaded) {
                    try { setSavedTemplates(JSON.parse(loaded)); } catch(e) {}
                }
            }, []);

            useEffect(() => {
                const tg = window.Telegram?.WebApp;
                if (!tg) return;
                if (step === 'edit') tg.BackButton.show();
                else tg.BackButton.hide();
            }, [step]);

            const triggerHaptic = (type = 'light') => {
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    try { window.Telegram.WebApp.HapticFeedback.impactOccurred(type); } 
                    catch (e) { 
                        if (['success','warning','error'].includes(type)) 
                            window.Telegram.WebApp.HapticFeedback.notificationOccurred(type);
                    }
                }
            };

            // –®–∞–±–ª–æ–Ω—ã —Å —Å–∂–∞—Ç–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const saveTemplate = async () => {
                if (!newTemplateName.trim()) return;
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∏–∑–∞–π–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                let designToSave = { ...design };

                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–∂–∏–º–∞–µ–º –µ–≥–æ
                if (design.bgImage) {
                    try {
                        const compressedBg = await compressImage(design.bgImage);
                        designToSave.bgImage = compressedBg;
                    } catch (e) {
                        console.warn("–°–∂–∞—Ç–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å");
                    }
                }

                const template = { 
                    id: Date.now(), 
                    name: newTemplateName, 
                    design: designToSave, 
                    socials: socials 
                };
                
                const updated = [...savedTemplates, template];
                
                try {
                    localStorage.setItem('flashpost_templates', JSON.stringify(updated));
                    setSavedTemplates(updated);
                    setNewTemplateName('');
                    setTemplateError(null);
                    triggerHaptic('success');
                } catch (e) {
                    console.error(e);
                    setTemplateError("–ü–∞–º—è—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã.");
                    triggerHaptic('error');
                }
            };

            const loadTemplate = (template) => {
                const loadedMainFont = FONTS.find(f => f.id === template.design.mainFont.id) || FONTS[0];
                const loadedAccentFont = FONTS.find(f => f.id === template.design.accentFont.id) || FONTS[3];
                
                // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ –±–µ–∑ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
                const loadedDesign = {
                    ...template.design,
                    mainFont: loadedMainFont,
                    accentFont: loadedAccentFont,
                    textColor: template.design.textColor || '#ffffff',
                    overlayColor: template.design.overlayColor || '#000000'
                };

                setDesign(loadedDesign);
                if (template.socials) setSocials(template.socials);
                setShowTemplatesModal(false);
                triggerHaptic('medium');
            };

            const deleteTemplate = (id) => {
                const updated = savedTemplates.filter(t => t.id !== id);
                setSavedTemplates(updated);
                try {
                    localStorage.setItem('flashpost_templates', JSON.stringify(updated));
                    setTemplateError(null);
                } catch(e) {}
                triggerHaptic('warning');
            };

            // Gemini API
            const callGemini = async (prompt, systemInstruction = "") => {
                const key = userApiKey || "";
                if (!key) throw new Error("–ù–µ—Ç API –∫–ª—é—á–∞");
                
                const model = "gemini-2.5-flash-preview-09-2025";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
                    generationConfig: { responseMimeType: "application/json" }
                };
                
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text.replace(/```json|```/g, "").trim());
            };

            const manualSplit = () => {
                const paragraphs = rawText.split(/\n\s*\n/).filter(t => t.trim());
                if (paragraphs.length === 0) return;
                const manualSlides = paragraphs.map((p, i) => ({
                    type: i === 0 ? 'title' : (i === paragraphs.length - 1 ? 'final' : 'content'),
                    content: p.trim()
                }));
                setSlides(manualSlides);
                setStep('edit');
                setCurrentIndex(0);
                triggerHaptic('success');
            };

            const processWithAI = async () => {
                if (!rawText.trim()) return;
                if (!userApiKey) { manualSplit(); return; }
                setStep('processing');
                setAiError(null);
                triggerHaptic('medium');
                try {
                    const systemPrompt = `–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π SMM-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –°–æ–∑–¥–∞–π –≤–∏—Ä–∞–ª—å–Ω—É—é –∫–∞—Ä—É—Å–µ–ª—å. 
                    –°–¢–†–£–ö–¢–£–†–ê: 
                    1. Title: –•—É–∫, –∏–Ω—Ç—Ä–∏–≥–∞ (–¥–æ 10 —Å–ª–æ–≤). 
                    2. Content: "–ú—è—Å–æ", 1 –º—ã—Å–ª—å –Ω–∞ —Å–ª–∞–π–¥. 
                    3. Final: CTA. 
                    –í—ã–¥–µ–ª–∏ 1-2 –≥–ª–∞–≤–Ω—ã—Ö —Å–ª–æ–≤–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏ *—Å–ª–æ–≤–æ*. JSON: { "slides": [ { "type": "title", "content": "..." } ] }`;
                    const result = await callGemini(rawText, systemPrompt);
                    setSlides(result.slides);
                    setStep('edit');
                    setCurrentIndex(0);
                    triggerHaptic('success');
                } catch (e) { 
                    setAiError("–û—à–∏–±–∫–∞. –ü—Ä–æ–±—É–µ–º –≤—Ä—É—á–Ω—É—é.");
                    manualSplit(); 
                }
            };

            const fetchAiIdeas = async () => {
                if (!userApiKey) return;
                setIsLlmLoading(true);
                setAiError(null);
                triggerHaptic('light');
                try {
                    const topic = rawText.trim() || "–¢—Ä–µ–Ω–¥—ã –±—É–¥—É—â–µ–≥–æ, –¥–µ–Ω—å–≥–∏, —É—Å–ø–µ—Ö";
                    const ideas = await callGemini(`8 –≤–∏—Ä–∞–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è Instagram –Ω–∞ —Ç–µ–º—É: "${topic}". –°–æ –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏ *–∞–∫—Ü–µ–Ω—Ç*. JSON –º–∞—Å—Å–∏–≤.`, "–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä.");
                    setAiIdeas(ideas);
                } catch (e) { setAiError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/–∫–ª—é—á–∞"); } 
                finally { setIsLlmLoading(false); }
            };

            const renderToCanvas = async (slideIndex, targetCanvas, w, h) => {
                const ctx = targetCanvas.getContext('2d');
                const slide = slides[slideIndex];
                if (!slide) return;
                targetCanvas.width = w;
                targetCanvas.height = h;

                const SAFE_ZONE_BOTTOM = 320; 
                const SIDE_PADDING = 90;
                const MAX_WIDTH = w - (SIDE_PADDING * 2);

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞
                if (design.bgImage) {
                    const img = new Image(); img.src = design.bgImage;
                    await new Promise(r => img.onload = r);
                    const ratio = Math.max(w / img.width, h / img.height);
                    const x = (w - img.width * ratio) / 2;
                    const y = (h - img.height * ratio) / 2;
                    ctx.drawImage(img, x, y, img.width * ratio, img.height * ratio);
                    
                    // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ/–û—Å–≤–µ—Ç–ª–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º overlayColor
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º hex –≤ rgb –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è opacity
                    const hex = design.overlayColor || '#000000';
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    ctx.fillStyle = `rgba(${r},${g},${b},${design.bgOpacity})`;
                    
                    ctx.fillRect(0,0, w, h);
                } else {
                    ctx.fillStyle = design.bgColor;
                    ctx.fillRect(0, 0, w, h);
                }

                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const fontSize = slide.type === 'title' ? 95 : 65; 
                const lineHeight = fontSize * 1.35;

                const drawRich = (text, x, y, maxWidth) => {
                    const words = (text || "").split(' ');
                    let lines = []; let current = [];
                    words.forEach(word => {
                        const clean = word.replace(/\*/g, '');
                        ctx.font = `bold ${fontSize}px ${design.mainFont.family}`;
                        const testLine = [...current, clean].join(' ');
                        if (ctx.measureText(testLine).width > maxWidth && current.length > 0) {
                            lines.push(current); current = [word];
                        } else { current.push(word); }
                    });
                    lines.push(current);
                    
                    let totalHeight = lines.length * lineHeight;
                    let startY = (h / 2 - 40) - totalHeight / 2 + lineHeight / 2;

                    lines.forEach((lineWords, lineIdx) => {
                        let totalW = 0;
                        lineWords.forEach(wrd => {
                            const isH = wrd.startsWith('*') && wrd.endsWith('*');
                            ctx.font = `bold ${fontSize}px ${isH ? design.accentFont.family : design.mainFont.family}`;
                            totalW += ctx.measureText(wrd.replace(/\*/g, '') + ' ').width;
                        });
                        let curX = x - totalW / 2;
                        lineWords.forEach(wrd => {
                            const isH = wrd.startsWith('*') && wrd.endsWith('*');
                            const clean = wrd.replace(/\*/g, '') + ' ';
                            ctx.font = `bold ${fontSize}px ${isH ? design.accentFont.family : design.mainFont.family}`;
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∞–∫—Ü–µ–Ω—Ç
                            ctx.fillStyle = isH ? design.highlightColor : design.textColor;
                            ctx.globalAlpha = design.textOpacity;
                            if (isH && design.shadow === 'glow') { ctx.shadowColor = design.highlightColor; ctx.shadowBlur = 30; } else { ctx.shadowBlur = 0; }
                            ctx.fillText(clean.trim(), curX + ctx.measureText(clean).width / 2, startY + lineIdx * lineHeight);
                            curX += ctx.measureText(clean).width;
                        });
                    });
                };

                drawRich(slide.type === 'title' ? slide.content.toUpperCase() : slide.content, w/2, h/2, MAX_WIDTH);
                
                ctx.shadowBlur = 0; ctx.globalAlpha = 0.85; ctx.fillStyle = design.textColor;
                ctx.font = `bold 34px ${design.mainFont.family}`;
                
                const footerY = h - 300; 
                if (slide.type === 'title' || slide.type === 'final') {
                    const contacts = [];
                    if (socials.instagram && socials.instagram.trim()) contacts.push({icon: 'IG', val: socials.instagram});
                    if (socials.telegram && socials.telegram.trim()) contacts.push({icon: 'TG', val: socials.telegram});
                    if (socials.newsletter && socials.newsletter.trim()) contacts.push({icon: '‚úâ', val: socials.newsletter});
                    contacts.forEach((c, i) => ctx.fillText(`${c.icon}: ${c.val}`, w/2, footerY + (i * 50)));
                } else { 
                    ctx.fillText(`${slideIndex + 1} / ${slides.length}`, w/2, h - 150); 
                }
            };

            const downloadCurrentSlide = () => {
                if (!canvasRef.current) return;
                triggerHaptic('medium');
                const link = document.createElement('a');
                link.download = `FlashPost_Slide_${currentIndex + 1}.png`;
                link.href = canvasRef.current.toDataURL('image/png');
                link.click();
            };

            useEffect(() => {
                if (step === 'edit' && canvasRef.current) renderToCanvas(currentIndex, canvasRef.current, 1080, 1350);
            }, [step, currentIndex, slides, design, socials]);

            if (step === 'input') {
                return (
                    <div className="min-h-screen bg-gradient-to-tr from-[#f09433] via-[#dc2743] to-[#bc1888] text-white flex flex-col p-6 overflow-hidden relative font-sans">
                        
                        <header className="relative flex flex-col items-center mb-6 z-10 text-center pt-6 w-full">
                            <button onClick={() => setShowTemplatesModal(true)} className="absolute left-0 top-6 p-2 bg-white/10 rounded-full active:scale-90"><Icon name="LayoutTemplate" size={20} /></button>
                            <button onClick={() => setShowSettings(true)} className="absolute right-0 top-6 p-2 bg-white/10 rounded-full active:scale-90"><Icon name="Settings2" size={20} /></button>
                            
                            <div className="w-16 h-16 bg-white/10 backdrop-blur-2xl border border-white/20 rounded-[28px] flex items-center justify-center shadow-2xl mb-3 logo-spin">
                                <Icon name="Sparkles" size={32} />
                            </div>
                            <h1 className="text-5xl font-black italic font-comfortaa drop-shadow-2xl tracking-tighter">FlashPost</h1>
                            <p className="text-xs font-bold mt-2 opacity-100 uppercase tracking-widest bg-white/15 px-4 py-1.5 rounded-full backdrop-blur-md shadow-lg glow-text border border-white/10">–¢–≤–æ–π —Ç–µ–∫—Å—Ç ‚Äî —Ç–≤–æ—è –º–∞–≥–∏—è ‚ú®</p>
                        </header>
                        
                        <div className="relative flex-1 space-y-6 z-10 overflow-y-auto no-scrollbar pb-24 w-full">
                            <textarea
                                className="w-full h-40 bg-white/10 backdrop-blur-xl border border-white/20 rounded-[32px] p-6 text-lg focus:outline-none placeholder-white/50 resize-none shadow-xl"
                                placeholder="–û —á–µ–º –ø–æ—Å—Ç?"
                                value={rawText} onChange={(e) => setRawText(e.target.value)}
                            />

                            <div className="space-y-3">
                                <label className="text-[10px] font-black uppercase ml-2 opacity-70">–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="bg-white/10 rounded-xl p-3 flex items-center gap-2 border border-white/10"><Icon name="Instagram" size={16} /><input className="bg-transparent border-none p-0 text-xs font-bold w-full outline-none" placeholder="@insta" value={socials.instagram} onChange={e => setSocials({...socials, instagram: e.target.value})} /></div>
                                    <div className="bg-white/10 rounded-xl p-3 flex items-center gap-2 border border-white/10"><Icon name="Send" size={16} /><input className="bg-transparent border-none p-0 text-xs font-bold w-full outline-none" placeholder="@tg" value={socials.telegram} onChange={e => setSocials({...socials, telegram: e.target.value})} /></div>
                                </div>
                                <div className="bg-white/10 rounded-xl p-3 flex items-center gap-2 border border-white/10"><Icon name="Mail" size={16} /><input className="bg-transparent border-none p-0 text-xs font-bold w-full outline-none" placeholder="–°–∞–π—Ç/—Ä–∞—Å—Å—ã–ª–∫–∞" value={socials.newsletter} onChange={e => setSocials({...socials, newsletter: e.target.value})} /></div>
                            </div>

                            <div className="space-y-3">
                                <label className="text-[10px] font-black uppercase ml-2 opacity-70">–ë—ã—Å—Ç—Ä—ã–µ –∏–¥–µ–∏</label>
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar px-1">
                                    {HOOK_SUGGESTIONS.map((hook, i) => (
                                        <button key={i} onClick={() => setRawText(hook)} className="flex-shrink-0 px-4 py-3 bg-white/10 rounded-xl text-[10px] font-bold backdrop-blur-md max-w-[200px] text-left active:scale-95 border border-white/10 shadow-lg">{hook}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-3">
                                <div className="flex justify-between px-2 items-center">
                                    <label className="text-[10px] font-black uppercase opacity-70">–ò–¥–µ–∏ (AI)</label>
                                    <button onClick={fetchAiIdeas} disabled={isLlmLoading || !userApiKey} className="text-[10px] bg-white/10 px-3 py-1 rounded-full flex items-center gap-1 active:scale-95">
                                        {isLlmLoading ? <Icon name="Loader2" size={10} className="animate-spin"/> : <Icon name="RefreshCcw" size={10}/>} –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                </div>
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar px-1">
                                    {aiIdeas.length === 0 ? (
                                        <div className="w-full py-3 bg-white/5 rounded-2xl text-[10px] text-center opacity-50 border border-white/10 border-dashed">{userApiKey ? "–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –¥–ª—è –∏–¥–µ–π" : "–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á"}</div>
                                    ) : aiIdeas.map((idea, i) => (
                                        <button key={i} onClick={() => setRawText(idea)} className="flex-shrink-0 px-4 py-3 bg-gradient-to-r from-white/20 to-white/5 rounded-xl text-[10px] font-bold backdrop-blur-md max-w-[200px] text-left active:scale-95 border border-white/10 shadow-lg">{idea}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="fixed bottom-6 left-6 right-6 z-20 flex gap-3">
                            <button onClick={manualSplit} className="flex-1 py-4 bg-white/10 backdrop-blur-xl border border-white/20 rounded-[24px] font-black text-xs uppercase active:scale-95 transition-all">–í—Ä—É—á–Ω—É—é</button>
                            <button onClick={processWithAI} className="flex-[2] py-4 bg-white text-black rounded-[24px] font-black text-lg shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-2">
                                –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∏—é <Icon name="Sparkles" size={20} className="fill-current text-purple-500"/>
                            </button>
                        </div>

                        {showSettings && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-md">
                                <div className="w-full bg-zinc-900 rounded-[32px] p-6 border border-white/10">
                                    <div className="flex justify-between items-center mb-4"><h2 className="font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><button onClick={() => setShowSettings(false)}><Icon name="X" size={20}/></button></div>
                                    <input type="password" placeholder="Gemini API Key" className="w-full bg-black rounded-xl p-3 text-sm text-white border border-white/20 mb-4" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} />
                                    <button onClick={() => setShowSettings(false)} className="w-full py-3 bg-white text-black rounded-xl font-bold text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (step === 'processing') {
                return (
                    <div className="min-h-screen bg-black flex flex-col items-center justify-center relative">
                        <div className="absolute inset-0 bg-gradient-to-tr from-purple-900/40 to-orange-900/40 animate-pulse"></div>
                        <Icon name="Sparkles" size={48} className="text-white animate-spin mb-4 relative z-10" />
                        <h2 className="text-xl font-bold relative z-10">–¢–≤–æ—Ä–∏–º...</h2>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-black text-white flex flex-col font-sans overflow-hidden">
                    <header className="p-4 flex justify-between items-center bg-white/5 backdrop-blur-md border-b border-white/5">
                        <button onClick={() => setStep('input')} className="p-2 bg-white/10 rounded-xl active:scale-90"><Icon name="ChevronLeft" size={20}/></button>
                        <div className="text-center"><span className="text-[10px] font-bold text-gray-400 block uppercase tracking-widest">–°–ª–∞–π–¥</span><span className="font-bold">{currentIndex + 1} –∏–∑ {slides.length}</span></div>
                        <button onClick={() => setShowTemplatesModal(true)} className="p-2 bg-white/10 rounded-xl active:scale-90 flex items-center gap-1"><Icon name="LayoutTemplate" size={18}/></button>
                    </header>

                    <div className="flex-1 overflow-y-auto pb-40 px-4 pt-6">
                        <div className="flex flex-col items-center gap-6">
                            <div className="relative w-full max-w-[300px] aspect-[4/5] shadow-2xl rounded-[32px] overflow-hidden border border-white/10">
                                <canvas ref={canvasRef} className="w-full h-full object-cover" />
                                <div className="absolute inset-y-0 left-0 w-12 flex items-center justify-center"><button onClick={() => setCurrentIndex(prev => Math.max(0, prev - 1))} className="p-2 bg-black/40 backdrop-blur-md rounded-full active:scale-75 transition-transform"><Icon name="ChevronLeft" size={20}/></button></div>
                                <div className="absolute inset-y-0 right-0 w-12 flex items-center justify-center"><button onClick={() => setCurrentIndex(prev => Math.min(slides.length - 1, prev + 1))} className="p-2 bg-black/40 backdrop-blur-md rounded-full active:scale-75 transition-transform"><Icon name="ChevronRight" size={20}/></button></div>
                            </div>
                            <button onClick={downloadCurrentSlide} className="flex items-center gap-2 px-6 py-3 bg-white text-black rounded-full font-bold text-sm shadow-lg active:scale-95 transition-transform"><Icon name="Download" size={18} /> –°–∫–∞—á–∞—Ç—å —ç—Ç–æ—Ç —Å–ª–∞–π–¥</button>
                            <div className="w-full bg-zinc-900/80 backdrop-blur-xl border border-white/10 rounded-[32px] p-6 space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2"><label className="text-[10px] uppercase font-bold text-gray-500">–®—Ä–∏—Ñ—Ç</label><select className="w-full bg-black border border-white/20 rounded-xl p-3 text-xs outline-none" onChange={(e) => setDesign({...design, mainFont: FONTS.find(f => f.id === e.target.value)})}>{FONTS.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select></div>
                                    <div className="space-y-2"><label className="text-[10px] uppercase font-bold text-gray-500 text-yellow-400">–ê–∫—Ü–µ–Ω—Ç</label><select className="w-full bg-black border border-white/20 rounded-xl p-3 text-xs outline-none" onChange={(e) => setDesign({...design, accentFont: FONTS.find(f => f.id === e.target.value)})}>{FONTS.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select></div>
                                </div>
                                
                                {/* –¢–µ–∫—Å—Ç –∏ –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */}
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <label className="text-[10px] uppercase font-bold text-gray-500">–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞</label>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[9px] uppercase font-bold text-gray-500">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</span>
                                            <div className="relative w-5 h-5 rounded-full overflow-hidden border border-white/20">
                                                <input type="color" className="absolute inset-0 w-full h-full opacity-0" value={design.textColor} onChange={(e) => setDesign({...design, textColor: e.target.value})} />
                                                <div className="w-full h-full" style={{backgroundColor: design.textColor}}></div>
                                            </div>
                                        </div>
                                    </div>
                                    <textarea className="w-full h-24 bg-black border border-white/20 rounded-xl p-3 text-sm focus:outline-none" value={slides[currentIndex]?.content} onChange={(e) => { const newSlides = [...slides]; newSlides[currentIndex].content = e.target.value; setSlides(newSlides); }} />
                                    <p className="text-[9px] text-gray-500">*–°–ª–æ–≤–∞ –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö* –º–µ–Ω—è—é—Ç —à—Ä–∏—Ñ—Ç –∏ —Ü–≤–µ—Ç</p>
                                </div>

                                {/* –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ü–≤–µ—Ç–∞ */}
                                <div className="space-y-4">
                                    <div className="flex gap-4 items-center">
                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-gray-500 mb-1 block">–§–æ–Ω (–¶–≤–µ—Ç)</label><div className="relative h-10 bg-white/5 border border-white/10 rounded-xl overflow-hidden"><input type="color" className="absolute inset-0 w-full h-full opacity-0" value={design.bgColor} onChange={(e) => setDesign({...design, bgColor: e.target.value, bgImage: null})} /><div className="w-full h-full" style={{backgroundColor: design.bgColor}}></div></div></div>
                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-gray-500 mb-1 block">–ê–∫—Ü–µ–Ω—Ç</label><div className="relative h-10 bg-white/5 border border-white/10 rounded-xl overflow-hidden"><input type="color" className="absolute inset-0 w-full h-full opacity-0" value={design.highlightColor} onChange={(e) => setDesign({...design, highlightColor: e.target.value})} /><div className="w-full h-full" style={{backgroundColor: design.highlightColor}}></div></div></div>
                                    </div>
                                    
                                    {/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ/–û—Å–≤–µ—Ç–ª–µ–Ω–∏–µ */}
                                    <div className="flex gap-4 items-center">
                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-gray-500 mb-1 block">–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ (–¶–≤–µ—Ç)</label><div className="relative h-10 bg-white/5 border border-white/10 rounded-xl overflow-hidden"><input type="color" className="absolute inset-0 w-full h-full opacity-0" value={design.overlayColor} onChange={(e) => setDesign({...design, overlayColor: e.target.value})} /><div className="w-full h-full" style={{backgroundColor: design.overlayColor}}></div></div></div>
                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-gray-500 mb-1 block">–°–∏–ª–∞ ({Math.round(design.bgOpacity*100)}%)</label><input type="range" min="0" max="1" step="0.1" value={design.bgOpacity} onChange={(e) => setDesign({...design, bgOpacity: parseFloat(e.target.value)})} className="w-full h-2 rounded-lg appearance-none cursor-pointer bg-white/20" /></div>
                                    </div>

                                    <label className="w-full py-3 border border-white/20 rounded-xl flex items-center justify-center gap-2 text-xs font-bold cursor-pointer active:scale-95 bg-white/5 hover:bg-white/10 transition-colors">
                                        <Icon name="Image" size={16} /> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–µ —Ñ–æ—Ç–æ
                                        <input type="file" className="hidden" accept="image/*" onChange={(e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (f) => setDesign({ ...design, bgImage: f.target.result }); reader.readAsDataURL(file); } }} />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showTemplatesModal && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm animate-in slide-in-from-bottom">
                            <div className="w-full bg-zinc-900 rounded-t-[32px] p-6 border-t border-white/10 h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center mb-6"><h2 className="font-bold text-lg">–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã</h2><button onClick={() => setShowTemplatesModal(false)}><Icon name="X" size={24}/></button></div>
                                <div className="flex gap-2 mb-2"><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è..." className="flex-1 bg-black p-4 rounded-xl text-sm border border-white/20" value={newTemplateName} onChange={e => setNewTemplateName(e.target.value)} /><button onClick={saveTemplate} className="bg-white text-black p-4 rounded-xl font-bold"><Icon name="Save" size={20}/></button></div>
                                {templateError && <div className="text-red-400 text-[10px] mb-4 text-center font-bold">{templateError}</div>}
                                <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar">{savedTemplates.length === 0 ? <div className="text-center text-gray-500 mt-10">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π</div> : savedTemplates.map(t => (<div key={t.id} className="flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/5"><div onClick={() => loadTemplate(t)} className="flex-1 cursor-pointer"><div className="font-bold">{t.name}</div><div className="text-[10px] text-gray-500 mt-1 flex gap-2"><span style={{color: t.design.highlightColor}}>‚óè –ê–∫—Ü–µ–Ω—Ç</span><span>{t.design.mainFont.name}</span></div></div><button onClick={() => deleteTemplate(t.id)} className="p-2 text-red-400 opacity-50 hover:opacity-100"><Icon name="Trash2" size={18}/></button></div>))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>