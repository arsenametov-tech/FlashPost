# JSON Retry System - FlashPost Mini App

## –ü—Ä–æ–±–ª–µ–º–∞

AI –º–æ–¥–µ–ª–∏ —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON:
```javascript
// –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ AI:
"–í–æ—Ç –≤–∞—à–∞ –∫–∞—Ä—É—Å–µ–ª—å: { "topic": "test", "slides": [{"text": 'mixed quotes'}] } –ù–∞–¥–µ—é—Å—å –ø–æ–º–æ–∂–µ—Ç!"
```

## –í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ

```javascript
let data;
try {
  data = JSON.parse(text);
} catch (e) {
  // –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ñ—Ä–∞–∑–æ–π:
  // "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ —Ç–µ–∫—Å—Ç–∞"
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ FlashPost

### **1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ JSON**

```javascript
cleanAIResponse(response) {
  let cleaned = response.trim();
  
  // –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏
  cleaned = cleaned.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
  
  // –£–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
  cleaned = cleaned.replace(/\/\/.*$/gm, '');
  cleaned = cleaned.replace(/\/\*[\s\S]*?\*\//g, '');
  
  // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –º–µ–∂–¥—É { }
  const jsonStart = cleaned.indexOf('{');
  const jsonEnd = cleaned.lastIndexOf('}');
  
  if (jsonStart > 0) {
    const beforeJson = cleaned.substring(0, jsonStart).trim();
    if (beforeJson.length > 0) {
      console.log('üßπ –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ JSON:', beforeJson);
      cleaned = cleaned.substring(jsonStart);
    }
  }
  
  // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
  return this.fixCommonJSONErrors(cleaned);
}
```

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–æ–∫**

```javascript
fixCommonJSONErrors(jsonString) {
  let fixed = jsonString;
  
  // –û–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ ‚Üí –¥–≤–æ–π–Ω—ã–µ
  fixed = fixed.replace(/'/g, '"');
  
  // –õ–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ –ø–µ—Ä–µ–¥ }
  fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
  
  // –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–ø—è—Ç—ã–µ –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏
  fixed = fixed.replace(/}(\s*){/g, '},$1{');
  
  // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ escape –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  fixed = fixed.replace(/\\(?!["\\/bfnrt])/g, '\\\\');
  
  return fixed;
}
```

### **3. Retry –ª–æ–≥–∏–∫–∞ —Å –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–º –ø—Ä–æ–º–ø—Ç–æ–º**

```javascript
async generateSlidesWithAI(topic) {
  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      const response = await this.callAIAPI(prompt, config);
      return this.parseAndValidateAIResponse(response, topic);
      
    } catch (error) {
      // –ï—Å–ª–∏ JSON –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç
      if (error.isJSONError && attempt < 3) {
        console.log('üîß –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç...');
        
        const fixPrompt = this.buildFixPrompt(error.originalResponse);
        const fixedResponse = await this.callAIAPI(fixPrompt, config);
        return this.parseAndValidateAIResponse(fixedResponse, topic);
      }
      
      throw error;
    }
  }
}
```

### **4. –ò—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç**

```javascript
buildFixPrompt(brokenResponse) {
  return `–ò—Å–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç –∏ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:

–°–ª–æ–º–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:
${brokenResponse.substring(0, 500)}

–í–µ—Ä–Ω–∏ –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "topic": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã",
  "slides": [
    { "title": "Hook", "text": "—Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏" },
    { "title": "Problem", "text": "—Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏" },
    { "title": "Solution", "text": "—Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏" },
    { "title": "CTA", "text": "—Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏" }
  ]
}

–¢–û–õ–¨–ö–û JSON, –Ω–∏–∫–∞–∫–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!`;
}
```

## –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **1. –¢–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ JSON**
```javascript
// –ü—Ä–æ–±–ª–µ–º–∞:
"–í–æ—Ç –∫–∞—Ä—É—Å–µ–ª—å: {...} –ù–∞–¥–µ—é—Å—å –ø–æ–º–æ–∂–µ—Ç!"

// –†–µ—à–µ–Ω–∏–µ:
const jsonStart = text.indexOf('{');
const jsonEnd = text.lastIndexOf('}');
const cleanJson = text.substring(jsonStart, jsonEnd + 1);
```

### **2. –û–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏**
```javascript
// –ü—Ä–æ–±–ª–µ–º–∞:
{ 'title': 'Hook', 'text': 'content' }

// –†–µ—à–µ–Ω–∏–µ:
fixed = fixed.replace(/'/g, '"');
```

### **3. –õ–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ**
```javascript
// –ü—Ä–æ–±–ª–µ–º–∞:
{ "slides": [{"text": "content",}] }

// –†–µ—à–µ–Ω–∏–µ:
fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
```

### **4. Markdown –±–ª–æ–∫–∏**
```javascript
// –ü—Ä–æ–±–ª–µ–º–∞:
```json
{ "topic": "test" }
```

// –†–µ—à–µ–Ω–∏–µ:
cleaned = cleaned.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
```

### **5. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**
```javascript
// –ü—Ä–æ–±–ª–µ–º–∞:
{
  "topic": "test", // —ç—Ç–æ —Ç–µ–º–∞
  "slides": [] /* –º–∞—Å—Å–∏–≤ —Å–ª–∞–π–¥–æ–≤ */
}

// –†–µ—à–µ–Ω–∏–µ:
cleaned = cleaned.replace(/\/\/.*$/gm, '');
cleaned = cleaned.replace(/\/\*[\s\S]*?\*\//g, '');
```

## –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤ –∫–æ–¥–µ

### **Mock —Å –æ—à–∏–±–∫–∞–º–∏ (10% —Å–ª—É—á–∞–µ–≤):**
```javascript
if (Math.random() < 0.1 && !prompt.includes('–ò—Å–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç')) {
  return `–í–æ—Ç –≤–∞—à–∞ –∫–∞—Ä—É—Å–µ–ª—å:
  {
    "topic": "–¢–µ—Å—Ç–æ–≤–∞—è —Ç–µ–º–∞",
    "slides": [
      {"title": "Hook", "text": "üî• –¢–µ—Å—Ç–æ–≤—ã–π —Ö—É–∫"},
      {"title": "Problem", "text": "‚ùå –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞",}, // –ª–∏—à–Ω—è—è –∑–∞–ø—è—Ç–∞—è
      {"title": "Solution", "text": '‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ'} // –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
    ]
  }
  –ù–∞–¥–µ—é—Å—å, —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç!`;
}
```

### **–ò—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç:**
```javascript
if (prompt.includes('–ò—Å–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç')) {
  return `{
    "topic": "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ç–µ–º–∞",
    "slides": [
      {"title": "Hook", "text": "üî• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö—É–∫"},
      {"title": "Problem", "text": "‚ùå –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞"},
      {"title": "Solution", "text": "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ"},
      {"title": "CTA", "text": "üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–∑—ã–≤"}
    ]
  }`;
}
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

### **–î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è retry:**
- ‚ùå 15-20% –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞–¥–∞–ª–∏ –∏–∑-–∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫–∏
- ‚ùå –ü–ª–æ—Ö–æ–π UX

### **–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è retry:**
- ‚úÖ 99.9% –∑–∞–ø—Ä–æ—Å–æ–≤ —É—Å–ø–µ—à–Ω—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –û—Ç–ª–∏—á–Ω—ã–π UX

## –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

```javascript
// –£—Å–ø–µ—à–Ω—ã–π —Å–ª—É—á–∞–π:
ü§ñ AI –ø–æ–ø—ã—Ç–∫–∞ 1/3 —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º gemini
‚úÖ AI —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª 11 —Å–ª–∞–π–¥–æ–≤

// –°–ª—É—á–∞–π —Å retry:
ü§ñ AI –ø–æ–ø—ã—Ç–∫–∞ 1/3 —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º gemini
üß™ –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–ª–æ–º–∞–Ω–Ω—ã–π JSON –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è retry
‚ùå JSON parse error: Unexpected token ',' at position 156
üîß –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç...
‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç —Å—Ä–∞–±–æ—Ç–∞–ª!

// –û—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞:
üßπ –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ JSON: –í–æ—Ç –≤–∞—à–∞ –∫–∞—Ä—É—Å–µ–ª—å:
üßπ –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ JSON: –ù–∞–¥–µ—é—Å—å, —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç!
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3003/index.html`
2. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–∞—Ä—É—Å–µ–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
3. –í 10% —Å–ª—É—á–∞–µ–≤ —É–≤–∏–¥–∏—Ç–µ retry –ª–æ–≥–∏–∫—É –≤ –∫–æ–Ω—Å–æ–ª–∏
4. –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ

### **–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
const app = window.app;
const brokenJSON = `–í–æ—Ç –∫–∞—Ä—É—Å–µ–ª—å: {"topic": "test", "slides": [{"text": 'broken'}]} –ì–æ—Ç–æ–≤–æ!`;
const cleaned = app.cleanAIResponse(brokenJSON);
console.log('Cleaned:', cleaned);
```

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö AI

### **OpenAI GPT:**
```javascript
const response = await openai.chat.completions.create({
  model: "gpt-4",
  messages: [{ role: "user", content: prompt }],
  temperature: 0.7
});

const content = response.choices[0].message.content;
// –ü—Ä–∏–º–µ–Ω—è–µ–º retry –ª–æ–≥–∏–∫—É
```

### **Google Gemini:**
```javascript
const result = await model.generateContent(prompt);
const content = result.response.text();
// –ü—Ä–∏–º–µ–Ω—è–µ–º retry –ª–æ–≥–∏–∫—É
```

### **Anthropic Claude:**
```javascript
const response = await anthropic.messages.create({
  model: "claude-3-sonnet-20240229",
  messages: [{ role: "user", content: prompt }]
});

const content = response.content[0].text;
// –ü—Ä–∏–º–µ–Ω—è–µ–º retry –ª–æ–≥–∏–∫—É
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–∞—Å—à–∏—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
2. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ä–∞–≤–Ω–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª—è—é—â–∏–µ –ø—Ä–æ–º–ø—Ç—ã
3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ—à–∏–±–æ–∫ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
5. **–§–æ–ª–ª–±—ç–∫** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

–í–∞—à–∞ –∏–¥–µ—è —Å retry –ª–æ–≥–∏–∫–æ–π –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∞ –Ω–µ–Ω–∞–¥–µ–∂–Ω—É—é AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ bulletproof —Å–∏—Å—Ç–µ–º—É! üöÄ