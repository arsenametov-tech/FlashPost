<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Unified State System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .slide-preview {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test: Unified State System</h1>
        <p>Testing the refactored single source of truth state management.</p>
        
        <div id="testResults"></div>
        
        <button onclick="runTests()">üöÄ Run Tests</button>
        <button onclick="testSlideCreation()">üìÑ Test Slide Creation</button>
        <button onclick="testTextBlocks()">üìù Test Text Blocks</button>
        <button onclick="testStateConsistency()">üîç Test State Consistency</button>
        
        <div id="slidePreview"></div>
    </div>

    <script src="app.js"></script>
    <script>
        let app;
        
        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function runTests() {
            document.getElementById('testResults').innerHTML = '';
            log('üß™ Starting unified state tests...', 'info');
            
            try {
                // Initialize app
                app = new FlashPostApp();
                log('‚úÖ App initialized successfully', 'success');
                
                // Test unified structure
                if (app.project && app.project.slides) {
                    log('‚úÖ Unified project structure exists', 'success');
                } else {
                    log('‚ùå Unified project structure missing', 'error');
                    return;
                }
                
                // Test single slide index
                if (typeof app.currentSlideIndex === 'number') {
                    log('‚úÖ Single slide index exists', 'success');
                } else {
                    log('‚ùå Single slide index missing', 'error');
                }
                
                // Check for old parallel structures
                if (app.slides || app.slideStyles || app.currentEditingSlide !== undefined) {
                    log('‚ö†Ô∏è Warning: Old parallel structures still exist', 'error');
                } else {
                    log('‚úÖ No parallel structures found', 'success');
                }
                
                log('üéâ Basic structure tests completed', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        function testSlideCreation() {
            log('üìÑ Testing slide creation...', 'info');
            
            try {
                if (!app) {
                    app = new FlashPostApp();
                }
                
                // Create test slides
                const testSlides = [
                    {
                        title: 'Test Slide 1',
                        text: 'This is test content for slide 1',
                        autoKeywords: ['test', 'slide']
                    },
                    {
                        title: 'Test Slide 2', 
                        text: 'This is test content for slide 2',
                        autoKeywords: ['content', 'example']
                    }
                ];
                
                // Simulate slide creation
                app.project.slides = testSlides.map((slideData, index) => {
                    const slideId = `slide_test_${index}`;
                    return {
                        id: slideId,
                        title: slideData.title,
                        text: slideData.text,
                        background: {
                            type: 'color',
                            color: '#833ab4',
                            image: null,
                            brightness: 100,
                            x: 50,
                            y: 50
                        },
                        autoKeywords: slideData.autoKeywords,
                        textBlocks: [
                            {
                                id: `block_test_${index}`,
                                text: slideData.text,
                                x: 50,
                                y: 50,
                                width: 80,
                                size: 16,
                                font: 'Inter',
                                weight: 700,
                                color: '#ffffff'
                            }
                        ]
                    };
                });
                
                if (app.project.slides.length === 2) {
                    log('‚úÖ Test slides created successfully', 'success');
                    log(`üìä Created ${app.project.slides.length} slides`, 'info');
                    
                    // Set first slide as active
                    app.project.activeSlideId = app.project.slides[0].id;
                    app.currentSlideIndex = 0;
                    
                    log('‚úÖ Active slide set successfully', 'success');
                } else {
                    log('‚ùå Slide creation failed', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Slide creation test failed: ${error.message}`, 'error');
            }
        }
        
        function testTextBlocks() {
            log('üìù Testing text block operations...', 'info');
            
            try {
                if (!app || !app.project.slides.length) {
                    testSlideCreation();
                }
                
                const currentSlide = app.project.slides[app.currentSlideIndex];
                if (!currentSlide) {
                    log('‚ùå No current slide found', 'error');
                    return;
                }
                
                log(`üìÑ Working with slide: ${currentSlide.title}`, 'info');
                log(`üìù Text blocks count: ${currentSlide.textBlocks.length}`, 'info');
                
                // Test text block access
                if (currentSlide.textBlocks && currentSlide.textBlocks.length > 0) {
                    const firstBlock = currentSlide.textBlocks[0];
                    log(`‚úÖ First text block: "${firstBlock.text.substring(0, 30)}..."`, 'success');
                    
                    // Test text block modification
                    const originalText = firstBlock.text;
                    firstBlock.text = 'Modified test text';
                    
                    if (firstBlock.text === 'Modified test text') {
                        log('‚úÖ Text block modification successful', 'success');
                        firstBlock.text = originalText; // Restore
                    } else {
                        log('‚ùå Text block modification failed', 'error');
                    }
                } else {
                    log('‚ùå No text blocks found', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Text block test failed: ${error.message}`, 'error');
            }
        }
        
        function testStateConsistency() {
            log('üîç Testing state consistency...', 'info');
            
            try {
                if (!app || !app.project.slides.length) {
                    testSlideCreation();
                }
                
                // Test slide index consistency
                const currentSlide = app.project.slides[app.currentSlideIndex];
                const activeSlide = app.project.slides.find(s => s.id === app.project.activeSlideId);
                
                if (currentSlide && activeSlide && currentSlide.id === activeSlide.id) {
                    log('‚úÖ Slide index and active ID are consistent', 'success');
                } else {
                    log('‚ùå Slide index and active ID inconsistency detected', 'error');
                }
                
                // Test single source of truth
                let stateConsistent = true;
                
                // Check that we're only using project.slides
                if (app.slides || app.slideStyles) {
                    log('‚ö†Ô∏è Warning: Parallel state structures detected', 'error');
                    stateConsistent = false;
                }
                
                // Check that currentSlideIndex is used instead of currentEditingSlide
                if (app.currentEditingSlide !== undefined) {
                    log('‚ö†Ô∏è Warning: Old currentEditingSlide still exists', 'error');
                    stateConsistent = false;
                }
                
                if (stateConsistent) {
                    log('‚úÖ State consistency check passed', 'success');
                } else {
                    log('‚ùå State consistency issues found', 'error');
                }
                
                // Display current state
                displayCurrentState();
                
            } catch (error) {
                log(`‚ùå State consistency test failed: ${error.message}`, 'error');
            }
        }
        
        function displayCurrentState() {
            const preview = document.getElementById('slidePreview');
            if (!app || !app.project.slides.length) {
                preview.innerHTML = '<p>No slides to display</p>';
                return;
            }
            
            let html = '<h3>üìä Current State:</h3>';
            html += `<div class="slide-preview">`;
            html += `<strong>Mode:</strong> ${app.project.mode}<br>`;
            html += `<strong>Current Slide Index:</strong> ${app.currentSlideIndex}<br>`;
            html += `<strong>Active Slide ID:</strong> ${app.project.activeSlideId}<br>`;
            html += `<strong>Total Slides:</strong> ${app.project.slides.length}<br>`;
            html += `<strong>Active Text Block ID:</strong> ${app.project.activeTextBlockId || 'None'}<br>`;
            html += `</div>`;
            
            // Display slides
            app.project.slides.forEach((slide, index) => {
                html += `<div class="slide-preview">`;
                html += `<strong>Slide ${index + 1}:</strong> ${slide.title}<br>`;
                html += `<strong>ID:</strong> ${slide.id}<br>`;
                html += `<strong>Background:</strong> ${slide.background.type} (${slide.background.color})<br>`;
                html += `<strong>Text Blocks:</strong> ${slide.textBlocks.length}<br>`;
                html += `<strong>Auto Keywords:</strong> ${slide.autoKeywords.join(', ')}<br>`;
                html += `</div>`;
            });
            
            preview.innerHTML = html;
        }
        
        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 1000);
        });
    </script>
</body>
</html>