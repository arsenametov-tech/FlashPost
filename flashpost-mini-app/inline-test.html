<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üîß Inline Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .console { background: #000; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üîß Inline Module Test</h1>
    <div id="results"></div>
    <div id="console" class="console"></div>

    <script>
        const results = document.getElementById('results');
        const consoleDiv = document.getElementById('console');
        
        function log(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            
            consoleDiv.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }
        
        window.addEventListener('error', function(event) {
            log(`‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${event.message} –≤ ${event.filename}:${event.lineno}`, 'error');
        });
        
        log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º inline —Ç–µ—Å—Ç...');
        
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è StateManager –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        class TestStateManager {
            constructor() {
                this.project = {
                    slides: [],
                    activeSlideId: null,
                    activeTextBlockId: null,
                    mode: 'start'
                };
                this.currentSlideIndex = 0;
                this.isGenerating = false;
                this.applyToAll = false;
                this.dragState = {
                    isDragging: false,
                    blockId: null
                };
                this.onPropertyChangeCallback = null;
                this.onModeChangeCallback = null;
                this.onSlideChangeCallback = null;
                log('‚úÖ TestStateManager —Å–æ–∑–¥–∞–Ω');
            }
            
            generateUID() {
                return `${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            }
            
            createSlide(data = {}) {
                const slideId = `slide_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                const newSlide = {
                    id: slideId,
                    title: data.title || '–ù–æ–≤—ã–π —Å–ª–∞–π–¥',
                    text: data.text || '–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞',
                    background: {
                        type: data.background?.type || 'color',
                        color: data.background?.color || '#833ab4',
                        image: data.background?.image || null,
                        x: data.background?.x || 50,
                        y: data.background?.y || 50,
                        brightness: data.background?.brightness || 100
                    },
                    textBlocks: data.textBlocks || [],
                    autoKeywords: data.autoKeywords || []
                };
                
                this.project.slides.push(newSlide);
                
                if (this.project.slides.length === 1) {
                    this.project.activeSlideId = slideId;
                }
                
                log(`‚úÖ –°–ª–∞–π–¥ —Å–æ–∑–¥–∞–Ω: ${slideId}`);
                return newSlide;
            }
            
            getMode() {
                return this.project.mode;
            }
            
            async setMode(newMode) {
                const validModes = ["start", "preview", "edit", "export"];
                if (!validModes.includes(newMode)) {
                    log(`‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–µ–∂–∏–º: ${newMode}`, 'error');
                    return false;
                }
                
                const oldMode = this.project.mode;
                this.project.mode = newMode;
                log(`‚úÖ –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω: ${oldMode} ‚Üí ${newMode}`);
                
                if (this.onModeChangeCallback) {
                    this.onModeChangeCallback(newMode, oldMode);
                }
                
                return true;
            }
            
            setPropertyChangeCallback(callback) {
                this.onPropertyChangeCallback = callback;
                log('‚úÖ –ö–æ–ª–±—ç–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
            
            setModeChangeCallback(callback) {
                this.onModeChangeCallback = callback;
                log('‚úÖ –ö–æ–ª–±—ç–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
        }
        
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Renderer
        class TestRenderer {
            constructor(stateManager) {
                this.state = stateManager;
                log('‚úÖ TestRenderer —Å–æ–∑–¥–∞–Ω');
            }
            
            render() {
                log('‚úÖ –†–µ–Ω–¥–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω');
                return true;
            }
        }
        
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Editor
        class TestEditor {
            constructor(stateManager, renderer) {
                this.state = stateManager;
                this.renderer = renderer;
                this.isIdeasCollapsed = true;
                
                if (this.state && this.renderer) {
                    log('‚úÖ TestEditor —Å–æ–∑–¥–∞–Ω —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏');
                } else {
                    log('‚ùå TestEditor —Å–æ–∑–¥–∞–Ω –ë–ï–ó –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π', 'error');
                }
            }
            
            cleanupEventHandlers() {
                log('‚úÖ –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π');
            }
            
            destroy() {
                this.cleanupEventHandlers();
                if (this.state) {
                    this.state.setPropertyChangeCallback(null);
                }
                log('‚úÖ Editor —É–Ω–∏—á—Ç–æ–∂–µ–Ω');
            }
        }
        
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è FlashPostApp
        class TestFlashPostApp {
            constructor() {
                try {
                    log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TestFlashPostApp...');
                    
                    this.state = new TestStateManager();
                    this.renderer = new TestRenderer(this.state);
                    this.editor = new TestEditor(this.state, this.renderer);
                    
                    this.setupModuleInteractions();
                    
                    log('‚úÖ TestFlashPostApp —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TestFlashPostApp: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            setupModuleInteractions() {
                this.state.setPropertyChangeCallback((hookData) => {
                    log(`üîÑ –ö–æ–ª–±—ç–∫ —Å–≤–æ–π—Å—Ç–≤–∞: ${hookData.property} –¥–ª—è –±–ª–æ–∫–∞ ${hookData.blockId}`);
                });
                
                this.state.setModeChangeCallback((newMode, oldMode) => {
                    log(`üîÑ –ö–æ–ª–±—ç–∫ —Ä–µ–∂–∏–º–∞: ${oldMode} ‚Üí ${newMode}`);
                });
                
                log('‚úÖ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–æ–¥—É–ª–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
            }
            
            async testBasicFunctionality() {
                log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏...');
                
                // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–∞
                const slide = this.state.createSlide({ title: '–¢–µ—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥' });
                if (slide && slide.id) {
                    log('‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    log('‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–∞ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
                }
                
                // –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
                const modeChanged = await this.state.setMode('preview');
                if (modeChanged) {
                    log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    log('‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
                }
                
                // –¢–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                const rendered = this.renderer.render();
                if (rendered) {
                    log('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    log('‚ùå –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error');
                }
                
                // –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
                this.editor.destroy();
                
                log('üéâ –í—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!');
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        try {
            log('üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            const testApp = new TestFlashPostApp();
            
            log('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏...');
            testApp.testBasicFunctionality().then(() => {
                log('üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!');
                log('‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                log('‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ–ª–±—ç–∫–æ–≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç');
                log('‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
            }).catch(error => {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö: ${error.message}`, 'error');
            });
            
        } catch (error) {
            log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            log(`Stack: ${error.stack}`, 'error');
        }
    </script>
</body>
</html>