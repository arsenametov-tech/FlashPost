<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Complete Diagnosis - FlashPost</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap&subset=latin,cyrillic" rel="stylesheet">
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            height: 100vh;
            height: 100dvh;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            background-size: 400% 400%;
            animation: gradientShift 4s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            animation: pulse 2s ease-in-out infinite;
            font-size: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* Diagnosis Styles */
        .diagnosis-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 15000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .diagnosis-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .diagnosis-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 1px solid #00ff00;
        }
        
        .diagnosis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .diagnosis-section {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            color: #ffff00;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .diagnosis-log {
            margin: 2px 0;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .success { 
            color: #00ff00; 
            background: rgba(0, 255, 0, 0.1);
        }
        .error { 
            color: #ff0000; 
            background: rgba(255, 0, 0, 0.1);
        }
        .warning { 
            color: #ffaa00; 
            background: rgba(255, 170, 0, 0.1);
        }
        .info {
            color: #00aaff;
            background: rgba(0, 170, 255, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: bold;
            font-size: 12px;
        }
        
        .close-diagnosis {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            z-index: 16000;
        }
        
        .close-diagnosis:hover {
            background: #cc0000;
        }
    </style>
</head>
<body>
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–∑—ã—Ä—å–∫–∏ -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading" id="loading">
        <div class="loading-icon">‚ö°</div>
        <div class="loading-text">FlashPost Mini App</div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app" id="app">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>

    <!-- Diagnosis Overlay -->
    <div class="diagnosis-overlay" id="diagnosis-overlay">
        <button class="close-diagnosis" onclick="closeDiagnosis()">‚úï Close</button>
        
        <div class="diagnosis-container">
            <div class="diagnosis-header">
                <h1>üîç COMPLETE DIAGNOSIS</h1>
                <p>–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ FlashPost –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="diagnosis-progress">0%</div>
                </div>
            </div>
            
            <div class="diagnosis-grid">
                <div class="diagnosis-section">
                    <div class="section-title">üì¶ Bootstrap Status</div>
                    <div id="bootstrap-logs"></div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="section-title">üîß Module Loading</div>
                    <div id="module-logs"></div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="section-title">üåê DOM Elements</div>
                    <div id="dom-logs"></div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="section-title">üöÄ App Initialization</div>
                    <div id="init-logs"></div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="section-title">‚ö†Ô∏è Errors</div>
                    <div id="error-logs"></div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="section-title">üìä Final Result</div>
                    <div id="result-logs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã -->
    <link rel="stylesheet" href="app.css">
    
    <script>
        // üîí STABLE BOOTSTRAP ‚Äî DO NOT BREAK
        // Complete Diagnosis System
        class CompleteDiagnosis {
            constructor() {
                this.startTime = Date.now();
                this.progress = 0;
                this.totalSteps = 10;
                this.logs = {
                    bootstrap: [],
                    module: [],
                    dom: [],
                    init: [],
                    error: [],
                    result: []
                };
                
                this.init();
            }
            
            init() {
                this.addBootstrapLog('üöÄ Complete Diagnosis Started', 'info');
                this.setupErrorHandling();
                this.startDiagnosis();
            }
            
            setupErrorHandling() {
                const originalError = console.error;
                const originalWarn = console.warn;
                const originalLog = console.log;
                
                console.error = (...args) => {
                    const message = args.join(' ');
                    this.addErrorLog(`‚ùå ${message}`, 'error');
                    originalError.apply(console, args);
                };
                
                console.warn = (...args) => {
                    const message = args.join(' ');
                    this.addErrorLog(`‚ö†Ô∏è ${message}`, 'warning');
                    originalWarn.apply(console, args);
                };
                
                console.log = (...args) => {
                    const message = args.join(' ');
                    if (message.includes('FlashPost') || message.includes('–º–æ–¥—É–ª') || message.includes('DOM') || message.includes('–∏–Ω–∏—Ü–∏–∞–ª–∏–∑')) {
                        if (message.includes('‚ùå')) {
                            this.addInitLog(message, 'error');
                        } else if (message.includes('‚úÖ')) {
                            this.addInitLog(message, 'success');
                        } else if (message.includes('‚è≥') || message.includes('‚ö†Ô∏è')) {
                            this.addInitLog(message, 'warning');
                        } else {
                            this.addInitLog(message, 'info');
                        }
                    }
                    originalLog.apply(console, args);
                };
                
                window.addEventListener('error', (event) => {
                    this.addErrorLog(`‚ùå RUNTIME: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    this.addErrorLog(`‚ùå PROMISE: ${event.reason}`, 'error');
                });
            }
            
            addLog(category, message, type = 'info') {
                const timestamp = Date.now() - this.startTime;
                const logEntry = {
                    timestamp,
                    message,
                    type,
                    time: new Date().toLocaleTimeString()
                };
                
                this.logs[category].push(logEntry);
                this.updateLogDisplay(category, logEntry);
            }
            
            addBootstrapLog(message, type = 'info') { this.addLog('bootstrap', message, type); }
            addModuleLog(message, type = 'info') { this.addLog('module', message, type); }
            addDomLog(message, type = 'info') { this.addLog('dom', message, type); }
            addInitLog(message, type = 'info') { this.addLog('init', message, type); }
            addErrorLog(message, type = 'error') { this.addLog('error', message, type); }
            addResultLog(message, type = 'info') { this.addLog('result', message, type); }
            
            updateLogDisplay(category, logEntry) {
                const container = document.getElementById(`${category}-logs`);
                if (container) {
                    const div = document.createElement('div');
                    div.className = `diagnosis-log ${logEntry.type}`;
                    div.innerHTML = `[+${logEntry.timestamp}ms] ${logEntry.message}`;
                    container.appendChild(div);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
                    if (container.children.length > 15) {
                        container.removeChild(container.firstChild);
                    }
                }
            }
            
            updateProgress(step, message) {
                this.progress = Math.round((step / this.totalSteps) * 100);
                
                const progressBar = document.getElementById('diagnosis-progress');
                if (progressBar) {
                    progressBar.style.width = `${this.progress}%`;
                    progressBar.textContent = `${this.progress}% - ${message}`;
                }
                
                this.addBootstrapLog(`üìä ${this.progress}% - ${message}`, 'info');
            }
            
            async startDiagnosis() {
                this.updateProgress(1, 'Checking Bootstrap');
                await this.checkBootstrap();
                
                this.updateProgress(2, 'Checking DOM');
                await this.checkDOM();
                
                this.updateProgress(4, 'Testing Modules');
                await this.testModules();
                
                this.updateProgress(7, 'Waiting for App');
                await this.waitForApp();
                
                this.updateProgress(9, 'Final Check');
                await this.finalCheck();
                
                this.updateProgress(10, 'Complete');
                this.generateResult();
            }
            
            async checkBootstrap() {
                this.addBootstrapLog(`üìÑ DOM State: ${document.readyState}`, 
                    document.readyState === 'complete' ? 'success' : 'warning');
                
                this.addBootstrapLog(`üåê URL: ${window.location.href}`, 'info');
                this.addBootstrapLog(`‚è∞ Start Time: ${new Date().toLocaleString()}`, 'info');
            }
            
            async checkDOM() {
                const requiredElements = ['app', 'loading'];
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        this.addDomLog(`‚úÖ #${elementId} found`, 'success');
                    } else {
                        this.addDomLog(`‚ùå #${elementId} NOT found`, 'error');
                    }
                });
            }
            
            async testModules() {
                const requiredModules = [
                    'StateManager', 'Renderer', 'Editor', 'DragManager',
                    'ExportManager', 'AIManager', 'TemplateManager', 'FlashPostApp'
                ];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
                for (let i = 0; i < 5; i++) {
                    let loadedCount = 0;
                    
                    requiredModules.forEach(module => {
                        if (typeof window[module] !== 'undefined') {
                            if (!this.logs.module.find(log => log.message.includes(`‚úÖ ${module}`))) {
                                this.addModuleLog(`‚úÖ ${module} loaded`, 'success');
                            }
                            loadedCount++;
                        }
                    });
                    
                    this.addModuleLog(`üìä Loaded: ${loadedCount}/${requiredModules.length}`, 
                        loadedCount === requiredModules.length ? 'success' : 'warning');
                    
                    if (loadedCount === requiredModules.length) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            async waitForApp() {
                // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                for (let i = 0; i < 10; i++) {
                    if (typeof window.flashPostApp !== 'undefined') {
                        this.addInitLog('‚úÖ FlashPostApp created!', 'success');
                        
                        if (window.flashPostApp.state) {
                            this.addInitLog('‚úÖ State available', 'success');
                            try {
                                const mode = window.flashPostApp.state.getMode();
                                this.addInitLog(`üéØ Mode: ${mode}`, 'success');
                            } catch (error) {
                                this.addInitLog(`‚ùå Mode error: ${error.message}`, 'error');
                            }
                        }
                        
                        if (window.flashPostApp.renderer) {
                            this.addInitLog('‚úÖ Renderer available', 'success');
                        }
                        
                        break;
                    } else {
                        if (i % 2 === 0) {
                            this.addInitLog(`‚è≥ Waiting... (${i}s)`, 'warning');
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (typeof window.flashPostApp === 'undefined') {
                    this.addInitLog('‚ùå App failed to initialize', 'error');
                }
            }
            
            async finalCheck() {
                const totalTime = Date.now() - this.startTime;
                this.addBootstrapLog(`‚è±Ô∏è Total time: ${totalTime}ms`, 'info');
                
                const errorCount = this.logs.error.length;
                this.addBootstrapLog(`üìä Errors: ${errorCount}`, errorCount === 0 ? 'success' : 'error');
            }
            
            generateResult() {
                const appInitialized = typeof window.flashPostApp !== 'undefined';
                const errorCount = this.logs.error.filter(log => log.type === 'error').length;
                const totalTime = Date.now() - this.startTime;
                
                let resultType, resultMessage;
                
                if (appInitialized && errorCount === 0) {
                    resultType = 'success';
                    resultMessage = 'üéâ DIAGNOSIS SUCCESS!\n‚úÖ App initialized\n‚úÖ No errors';
                } else if (appInitialized) {
                    resultType = 'warning';
                    resultMessage = `‚ö†Ô∏è PARTIAL SUCCESS\n‚úÖ App initialized\n‚ö†Ô∏è ${errorCount} errors`;
                } else {
                    resultType = 'error';
                    resultMessage = `‚ùå DIAGNOSIS FAILED\n‚ùå App not initialized\n‚ùå ${errorCount} errors`;
                }
                
                this.addResultLog(resultMessage, resultType);
                this.addResultLog(`‚è±Ô∏è Time: ${totalTime}ms`, 'info');
                
                // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log('='.repeat(50));
                console.log('COMPLETE DIAGNOSIS RESULT');
                console.log('='.repeat(50));
                console.log(`Status: ${appInitialized ? 'SUCCESS' : 'FAILED'}`);
                console.log(`Errors: ${errorCount}`);
                console.log(`Time: ${totalTime}ms`);
                console.log('='.repeat(50));
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        function closeDiagnosis() {
            const overlay = document.getElementById('diagnosis-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // üîí STABLE BOOTSTRAP ‚Äî DO NOT BREAK
        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        let completeDiagnosis;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                completeDiagnosis = new CompleteDiagnosis();
            });
        } else {
            completeDiagnosis = new CompleteDiagnosis();
        }
    </script>
    
    <!-- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ -->
    <script src="src/state.js" defer></script>
    <script src="src/renderer.js" defer></script>
    <script src="src/editor.js" defer></script>
    <script src="src/drag.js" defer></script>
    <script src="src/export.js" defer></script>
    <script src="src/ai.js" defer></script>
    <script src="src/template-manager.js" defer></script>
    <script src="src/app.js" defer></script>
</body>
</html>