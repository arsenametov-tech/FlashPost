<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual White Screen Diagnosis</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Main App CSS -->
    <link rel="stylesheet" href="app.css">
    
    <style>
        /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ */
        .diagnosis-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 10px;
            z-index: 10000;
            overflow-y: auto;
            border-left: 2px solid #833ab4;
        }
        
        .diagnosis-section {
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 4px;
        }
        
        .diagnosis-title {
            color: #833ab4;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .pass { color: #28a745; }
        .fail { color: #dc3545; }
        .warning { color: #ffc107; }
        
        .debug-button {
            background: #833ab4;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin: 2px;
        }
        
        .debug-button:hover {
            background: #6c2e8f;
        }
        
        .debug-red {
            background: #dc3545 !important;
            color: white !important;
            font-size: 24px !important;
            font-weight: bold !important;
            padding: 20px !important;
            text-align: center !important;
            min-height: 100vh !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-icon">‚ö°</div>
        <div class="loading-text">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞...</div>
    </div>

    <!-- App Container -->
    <div id="app"></div>
    
    <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="diagnosis-overlay" id="diagnosisPanel">
        <div class="diagnosis-title">üîç VISUAL WHITE SCREEN DIAGNOSIS</div>
        
        <!-- 1. CSS Layout Check -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">1. CSS Layout Check</div>
            <div id="cssLayoutResults">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
            <button class="debug-button" onclick="checkCSSLayout()">üîÑ Recheck</button>
        </div>
        
        <!-- 2. Position Check -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">2. Position Check</div>
            <div id="positionResults">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
            <button class="debug-button" onclick="checkPositioning()">üîÑ Recheck</button>
        </div>
        
        <!-- 3. RenderApp Check -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">3. RenderApp Check</div>
            <div id="renderAppResults">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
            <button class="debug-button" onclick="checkRenderApp()">üîÑ Recheck</button>
            <button class="debug-button" onclick="forceRenderApp()">üî¥ Force Render</button>
        </div>
        
        <!-- 4. Debug UI -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">4. Debug UI</div>
            <div id="debugUIResults">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç—É</div>
            <button class="debug-button" onclick="addDebugUI()">üî¥ Add Red Debug</button>
            <button class="debug-button" onclick="removeDebugUI()">‚ùå Remove Debug</button>
        </div>
        
        <!-- 5. Telegram Expand Check -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">5. Telegram Expand</div>
            <div id="telegramResults">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
            <button class="debug-button" onclick="checkTelegramExpand()">üîÑ Recheck</button>
            <button class="debug-button" onclick="forceTelegramExpand()">üì± Force Expand</button>
        </div>
        
        <!-- –û–±—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">üõ†Ô∏è Actions</div>
            <button class="debug-button" onclick="runFullDiagnosis()">üîç Full Diagnosis</button>
            <button class="debug-button" onclick="fixAllIssues()">üîß Fix All</button>
            <button class="debug-button" onclick="togglePanel()">üëÅÔ∏è Hide Panel</button>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="diagnosis-section">
            <div class="diagnosis-title">üìä Summary</div>
            <div id="summaryResults">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</div>
        </div>
    </div>

    <!-- Main App Scripts -->
    <script src="src/state.js" defer></script>
    <script src="src/renderer.js" defer></script>
    <script src="src/editor.js" defer></script>
    <script src="src/drag.js" defer></script>
    <script src="src/export.js" defer></script>
    <script src="src/ai.js" defer></script>
    <script src="src/template-manager.js" defer></script>
    <script src="src/app.js" defer></script>

    <script>
        let diagnosisResults = {};
        let tg = window.Telegram?.WebApp;
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ CSS Layout
        function checkCSSLayout() {
            console.log('üîç Checking CSS Layout...');
            
            const html = document.documentElement;
            const body = document.body;
            const app = document.getElementById('app');
            
            const htmlStyles = window.getComputedStyle(html);
            const bodyStyles = window.getComputedStyle(body);
            const appStyles = app ? window.getComputedStyle(app) : null;
            
            const results = {
                html: {
                    height: htmlStyles.height,
                    margin: htmlStyles.margin,
                    padding: htmlStyles.padding,
                    background: htmlStyles.backgroundColor
                },
                body: {
                    height: bodyStyles.height,
                    margin: bodyStyles.margin,
                    padding: bodyStyles.padding,
                    background: bodyStyles.backgroundColor,
                    minHeight: bodyStyles.minHeight
                },
                app: app ? {
                    exists: true,
                    height: appStyles.height,
                    minHeight: appStyles.minHeight,
                    background: appStyles.backgroundColor,
                    display: appStyles.display,
                    position: appStyles.position
                } : { exists: false }
            };
            
            diagnosisResults.cssLayout = results;
            
            let output = '';
            
            // HTML –ø—Ä–æ–≤–µ—Ä–∫–∏
            output += `<strong>HTML:</strong><br>`;
            output += `height: ${results.html.height} ${results.html.height === '100%' ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `background: ${results.html.background}<br>`;
            
            // BODY –ø—Ä–æ–≤–µ—Ä–∫–∏
            output += `<strong>BODY:</strong><br>`;
            output += `height: ${results.body.height} ${results.body.height === '100%' ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `margin: ${results.body.margin} ${results.body.margin === '0px' ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `padding: ${results.body.padding} ${results.body.padding === '0px' ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `background: ${results.body.background}<br>`;
            
            // APP –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (results.app.exists) {
                output += `<strong>#APP:</strong><br>`;
                output += `exists: <span class="pass">‚úì</span><br>`;
                output += `min-height: ${results.app.minHeight} ${results.app.minHeight.includes('100vh') ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
                output += `display: ${results.app.display} ${results.app.display === 'block' ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
                output += `background: ${results.app.background}<br>`;
            } else {
                output += `<strong>#APP:</strong> <span class="fail">NOT FOUND ‚úó</span><br>`;
            }
            
            document.getElementById('cssLayoutResults').innerHTML = output;
            return results;
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function checkPositioning() {
            console.log('üîç Checking Positioning...');
            
            const app = document.getElementById('app');
            const loading = document.getElementById('loading');
            
            const results = {
                app: app ? {
                    position: window.getComputedStyle(app).position,
                    top: window.getComputedStyle(app).top,
                    left: window.getComputedStyle(app).left,
                    width: window.getComputedStyle(app).width,
                    height: window.getComputedStyle(app).height,
                    zIndex: window.getComputedStyle(app).zIndex
                } : null,
                loading: loading ? {
                    position: window.getComputedStyle(loading).position,
                    display: window.getComputedStyle(loading).display,
                    zIndex: window.getComputedStyle(loading).zIndex
                } : null
            };
            
            diagnosisResults.positioning = results;
            
            let output = '';
            
            if (results.app) {
                output += `<strong>#APP Position:</strong><br>`;
                output += `position: ${results.app.position}<br>`;
                
                if (results.app.position === 'fixed' || results.app.position === 'absolute') {
                    output += `<span class="warning">‚ö†Ô∏è Fixed/Absolute position detected</span><br>`;
                    output += `top: ${results.app.top}<br>`;
                    output += `left: ${results.app.left}<br>`;
                    output += `width: ${results.app.width}<br>`;
                    output += `height: ${results.app.height}<br>`;
                } else {
                    output += `<span class="pass">‚úì Safe position</span><br>`;
                }
                
                output += `z-index: ${results.app.zIndex}<br>`;
            } else {
                output += `<span class="fail">#APP not found ‚úó</span><br>`;
            }
            
            if (results.loading) {
                output += `<strong>#LOADING:</strong><br>`;
                output += `display: ${results.loading.display}<br>`;
                output += `z-index: ${results.loading.zIndex}<br>`;
                
                if (results.loading.display !== 'none') {
                    output += `<span class="warning">‚ö†Ô∏è Loading still visible</span><br>`;
                } else {
                    output += `<span class="pass">‚úì Loading hidden</span><br>`;
                }
            }
            
            document.getElementById('positionResults').innerHTML = output;
            return results;
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ renderApp()
        function checkRenderApp() {
            console.log('üîç Checking RenderApp...');
            
            const app = document.getElementById('app');
            const hasFlashPostApp = !!window.flashPostApp;
            const hasRenderApp = hasFlashPostApp && typeof window.flashPostApp.renderApp === 'function';
            
            const results = {
                appExists: !!app,
                appContent: app ? app.innerHTML.length : 0,
                appEmpty: app ? app.innerHTML.trim() === '' : true,
                flashPostAppExists: hasFlashPostApp,
                renderAppExists: hasRenderApp,
                lastRenderTime: window.lastRenderTime || 'never'
            };
            
            diagnosisResults.renderApp = results;
            
            let output = '';
            output += `#app exists: ${results.appExists ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `#app content: ${results.appContent} chars<br>`;
            output += `#app empty: ${results.appEmpty ? '<span class="fail">‚úó EMPTY</span>' : '<span class="pass">‚úì HAS CONTENT</span>'}<br>`;
            output += `flashPostApp: ${results.flashPostAppExists ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `renderApp(): ${results.renderAppExists ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            output += `Last render: ${results.lastRenderTime}<br>`;
            
            document.getElementById('renderAppResults').innerHTML = output;
            return results;
        }
        
        // 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ debug UI
        function addDebugUI() {
            console.log('üî¥ Adding Debug UI...');
            
            const app = document.getElementById('app');
            if (!app) {
                console.error('‚ùå #app not found for debug UI');
                return;
            }
            
            // –í—Ä–µ–º–µ–Ω–Ω—ã–π debug UI —Å –∫—Ä–∞—Å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
            app.innerHTML = `
                <div class="debug-red">
                    üî¥ DEBUG UI ACTIVE<br>
                    <div style="font-size: 16px; margin-top: 20px;">
                        ‚úÖ #app element exists<br>
                        ‚úÖ innerHTML can be set<br>
                        ‚úÖ CSS styles apply<br>
                        ‚úÖ Red text visible<br>
                        ‚úÖ Full height works<br>
                        <div style="margin-top: 20px; font-size: 12px;">
                            Time: ${new Date().toLocaleTimeString()}<br>
                            Viewport: ${window.innerWidth}x${window.innerHeight}
                        </div>
                    </div>
                </div>
            `;
            
            // –°–∫—Ä—ã–≤–∞–µ–º loading
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
            
            document.getElementById('debugUIResults').innerHTML = `
                <span class="pass">‚úÖ Debug UI added</span><br>
                Red text should be visible<br>
                Time: ${new Date().toLocaleTimeString()}
            `;
            
            window.lastRenderTime = new Date().toLocaleTimeString();
        }
        
        function removeDebugUI() {
            console.log('‚ùå Removing Debug UI...');
            
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = '';
            }
            
            document.getElementById('debugUIResults').innerHTML = `
                <span class="warning">‚ö™ Debug UI removed</span><br>
                #app is now empty
            `;
        }
        
        // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram expand
        function checkTelegramExpand() {
            console.log('üì± Checking Telegram Expand...');
            
            const results = {
                telegramAvailable: !!tg,
                version: tg ? tg.version : 'N/A',
                isExpanded: tg ? tg.isExpanded : false,
                viewportHeight: tg ? tg.viewportHeight : 'N/A',
                stableHeight: tg ? tg.viewportStableHeight : 'N/A',
                windowHeight: window.innerHeight
            };
            
            diagnosisResults.telegram = results;
            
            let output = '';
            output += `Telegram SDK: ${results.telegramAvailable ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó</span>'}<br>`;
            
            if (results.telegramAvailable) {
                output += `Version: ${results.version}<br>`;
                output += `Expanded: ${results.isExpanded ? '<span class="pass">‚úì</span>' : '<span class="fail">‚úó NOT EXPANDED</span>'}<br>`;
                output += `TG Height: ${results.viewportHeight}px<br>`;
                output += `Stable: ${results.stableHeight}px<br>`;
                output += `Window: ${results.windowHeight}px<br>`;
                
                if (results.viewportHeight < 400) {
                    output += `<span class="fail">‚ö†Ô∏è Height too small</span><br>`;
                }
            } else {
                output += `<span class="warning">Running outside Telegram</span><br>`;
                output += `Window: ${results.windowHeight}px<br>`;
            }
            
            document.getElementById('telegramResults').innerHTML = output;
            return results;
        }
        
        function forceTelegramExpand() {
            console.log('üì± Force Telegram Expand...');
            
            if (tg) {
                try {
                    tg.ready();
                    tg.expand();
                    console.log('‚úÖ Telegram expand called');
                    
                    setTimeout(() => {
                        checkTelegramExpand();
                    }, 500);
                } catch (error) {
                    console.error('‚ùå Error expanding Telegram:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Telegram not available');
            }
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ renderApp
        function forceRenderApp() {
            console.log('üî¥ Force RenderApp...');
            
            if (window.flashPostApp && window.flashPostApp.renderApp) {
                try {
                    window.flashPostApp.renderApp();
                    console.log('‚úÖ Main app renderApp() called');
                    
                    setTimeout(() => {
                        checkRenderApp();
                    }, 500);
                } catch (error) {
                    console.error('‚ùå Error calling renderApp():', error);
                    addDebugUI(); // Fallback to debug UI
                }
            } else {
                console.log('‚ö†Ô∏è Main app not available, using debug UI');
                addDebugUI();
            }
        }
        
        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runFullDiagnosis() {
            console.log('üîç Running Full Diagnosis...');
            
            const results = {
                cssLayout: checkCSSLayout(),
                positioning: checkPositioning(),
                renderApp: checkRenderApp(),
                telegram: checkTelegramExpand()
            };
            
            // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const issues = [];
            const passes = [];
            
            // CSS Layout issues
            if (!results.cssLayout.app.exists) {
                issues.push('#app element missing');
            }
            if (!results.cssLayout.app.minHeight?.includes('100vh')) {
                issues.push('#app min-height not 100vh');
            }
            if (results.cssLayout.body.margin !== '0px') {
                issues.push('body margin not 0');
            }
            
            // Position issues
            if (results.positioning.app?.position === 'fixed' || results.positioning.app?.position === 'absolute') {
                if (results.positioning.app.width === 'auto' || results.positioning.app.height === 'auto') {
                    issues.push('fixed/absolute without explicit size');
                }
            }
            
            // RenderApp issues
            if (results.renderApp.appEmpty) {
                issues.push('#app is empty');
            }
            if (!results.renderApp.renderAppExists) {
                issues.push('renderApp() not available');
            }
            
            // Telegram issues
            if (results.telegram.telegramAvailable && !results.telegram.isExpanded) {
                issues.push('Telegram not expanded');
            }
            
            // Passes
            if (results.cssLayout.app.exists) passes.push('‚úÖ #app exists');
            if (results.cssLayout.body.margin === '0px') passes.push('‚úÖ body margin 0');
            if (results.renderApp.renderAppExists) passes.push('‚úÖ renderApp() available');
            if (!results.telegram.telegramAvailable || results.telegram.isExpanded) passes.push('‚úÖ Telegram OK');
            
            let summary = '';
            if (passes.length > 0) {
                summary += `<div class="pass">${passes.join('<br>')}</div>`;
            }
            if (issues.length > 0) {
                summary += `<div class="fail">ISSUES:<br>${issues.join('<br>')}</div>`;
            } else {
                summary += `<div class="pass">‚úÖ No issues detected!</div>`;
            }
            
            document.getElementById('summaryResults').innerHTML = summary;
            
            return { results, issues, passes };
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º
        function fixAllIssues() {
            console.log('üîß Fixing All Issues...');
            
            // 1. –°–æ–∑–¥–∞–µ–º #app –µ—Å–ª–∏ –Ω–µ—Ç
            let app = document.getElementById('app');
            if (!app) {
                app = document.createElement('div');
                app.id = 'app';
                document.body.appendChild(app);
                console.log('‚úÖ Created #app element');
            }
            
            // 2. –ü—Ä–∏–º–µ–Ω—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ CSS —Å—Ç–∏–ª–∏
            document.documentElement.style.cssText = `
                margin: 0;
                padding: 0;
                height: 100%;
                background: #0f0f14;
            `;
            
            document.body.style.cssText = `
                margin: 0;
                padding: 0;
                height: 100%;
                background: #0f0f14;
                color: #ffffff;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            app.style.cssText = `
                min-height: 100vh;
                background: #0f0f14;
                color: #fff;
                display: block;
                position: relative;
            `;
            
            // 3. –°–∫—Ä—ã–≤–∞–µ–º loading
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
            
            // 4. –í—ã–∑—ã–≤–∞–µ–º Telegram expand
            if (tg) {
                try {
                    tg.ready();
                    tg.expand();
                } catch (error) {
                    console.error('Error with Telegram:', error);
                }
            }
            
            // 5. –î–æ–±–∞–≤–ª—è–µ–º debug UI
            addDebugUI();
            
            // 6. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            setTimeout(() => {
                runFullDiagnosis();
            }, 1000);
            
            console.log('‚úÖ All fixes applied');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
        function togglePanel() {
            const panel = document.getElementById('diagnosisPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            console.log('üîç Visual White Screen Diagnosis loaded');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                console.log('üîÑ Running automatic diagnosis...');
                runFullDiagnosis();
            }, 2000);
            
            // –°–∫—Ä—ã–≤–∞–µ–º loading —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –≤—Å–µ –µ—â–µ –≤–∏–¥–∏–º
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading && window.getComputedStyle(loading).display !== 'none') {
                    console.log('‚è∞ Auto-hiding loading screen');
                    loading.style.display = 'none';
                }
            }, 3000);
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        window.checkCSSLayout = checkCSSLayout;
        window.checkPositioning = checkPositioning;
        window.checkRenderApp = checkRenderApp;
        window.addDebugUI = addDebugUI;
        window.checkTelegramExpand = checkTelegramExpand;
        window.runFullDiagnosis = runFullDiagnosis;
        window.fixAllIssues = fixAllIssues;
        
        console.log('üí° Available commands: checkCSSLayout(), addDebugUI(), runFullDiagnosis(), fixAllIssues()');
    </script>
</body>
</html>