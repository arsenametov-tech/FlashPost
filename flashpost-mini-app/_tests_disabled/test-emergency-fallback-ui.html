<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashPost Emergency Fallback UI Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .test-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(131, 58, 180, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .status-ok {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        
        .status-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üö® FlashPost Emergency Fallback UI Test</h1>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É Emergency Fallback UI —Å–∏—Å—Ç–µ–º—ã FlashPost.</p>
        
        <div class="test-section">
            <h2>üìã Test Scenarios</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Emergency Fallback UI:</p>
            
            <button class="btn btn-danger" onclick="testRenderFailure()">
                üö® Simulate Render Failure
            </button>
            
            <button class="btn btn-warning" onclick="testMissingModules()">
                üì¶ Simulate Missing Modules
            </button>
            
            <button class="btn btn-warning" onclick="testMissingDOM()">
                üîç Simulate Missing DOM
            </button>
            
            <button class="btn btn-success" onclick="testDirectEmergencyUI()">
                ‚úÖ Show Emergency UI Directly
            </button>
            
            <button class="btn" onclick="resetTest()">
                üîÑ Reset Test
            </button>
        </div>
        
        <div class="test-section">
            <h2>üìä Test Status</h2>
            <div id="testStatus">
                <div class="status status-ok">‚úÖ Test environment ready</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîß Emergency UI Features</h2>
            <p>Emergency Fallback UI –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:</p>
            <ul>
                <li>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á—Ç–æ JavaScript —Ä–∞–±–æ—Ç–∞–µ—Ç</li>
                <li>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á—Ç–æ DOM –¥–æ—Å—Ç—É–ø–µ–Ω</li>
                <li>üîÑ –ö–Ω–æ–ø–∫–∞ "Reload UI" –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</li>
                <li>üîß –ö–Ω–æ–ø–∫–∞ "Reset State" –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</li>
                <li>üöÄ –ö–Ω–æ–ø–∫–∞ "Force Reload" –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</li>
                <li>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π</li>
                <li>‚è∞ Timestamp —Å–æ–∑–¥–∞–Ω–∏—è Emergency UI</li>
            </ul>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ FlashPost –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <script>
        // Mock FlashPost modules –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        // Mock StateManager
        class StateManager {
            constructor() {
                this.mode = 'start';
            }
            
            getMode() {
                return this.mode;
            }
            
            getSlidesCount() {
                return 0;
            }
        }
        
        // Mock Renderer
        class Renderer {
            constructor(state) {
                this.state = state;
            }
            
            render() {
                throw new Error('Simulated render failure');
            }
        }
        
        // Mock Editor
        class Editor {
            constructor(state, renderer) {
                this.state = state;
                this.renderer = renderer;
            }
        }
        
        // Expose classes globally
        window.StateManager = StateManager;
        window.Renderer = Renderer;
        window.Editor = Editor;
        
        // Mock FlashPostApp with Emergency Fallback UI
        class FlashPostApp {
            constructor() {
                this.state = new StateManager();
                this.renderer = new Renderer(this.state);
                this.editor = new Editor(this.state, this.renderer);
            }
            
            async init() {
                console.log('üöÄ FlashPostApp initialized for testing');
            }
            
            checkModulesAvailable() {
                return window.testModulesAvailable !== false;
            }
            
            async initializeDefaultState() {
                console.log('üîß Default state initialized');
            }
            
            bindUIEvents() {
                console.log('üîó UI events bound');
            }
            
            async renderApp() {
                console.log('üé® renderApp() called');
                
                try {
                    const app = document.getElementById('app');
                    
                    if (!app && window.testMissingDOM) {
                        console.error('‚ùå #app element not found - activating emergency fallback');
                        this.renderEmergencyFallbackUI();
                        return;
                    }
                    
                    const modulesAvailable = this.checkModulesAvailable();
                    if (!modulesAvailable) {
                        console.log('‚ö†Ô∏è Modules unavailable, activating emergency fallback UI');
                        this.renderEmergencyFallbackUI();
                        return;
                    }
                    
                    if (window.testRenderFailure) {
                        throw new Error('Simulated render failure for testing');
                    }
                    
                    this.renderer.render();
                    this.bindUIEvents();
                    
                    console.log('‚úÖ App rendered successfully');
                    
                } catch (error) {
                    console.error('‚ùå Render error:', error);
                    console.log('üö® EMERGENCY: Main render failed, activating emergency fallback UI');
                    this.renderEmergencyFallbackUI();
                }
            }
            
            // EMERGENCY FALLBACK UI - –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ JS –∂–∏–≤ –∏ DOM –¥–æ—Å—Ç—É–ø–µ–Ω
            renderEmergencyFallbackUI() {
                console.log('üö® EMERGENCY FALLBACK: Rendering emergency UI - JS is alive!');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                document.body.innerHTML = '';
                document.body.style.cssText = `
                    margin: 0;
                    padding: 0;
                    min-height: 100vh;
                    background: linear-gradient(135deg, #0f0f14 0%, #1a1a2e 50%, #16213e 100%);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    color: white;
                    display: flex !important;
                    align-items: center;
                    justify-content: center;
                `;
                
                // –°–æ–∑–¥–∞–µ–º emergency UI
                const emergencyContainer = document.createElement('div');
                emergencyContainer.style.cssText = `
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(20px);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 600px;
                    width: 90%;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    text-align: center;
                `;
                
                emergencyContainer.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h1 style="
                            font-size: 32px;
                            font-weight: 800;
                            background: linear-gradient(45deg, #4CAF50 0%, #8BC34A 50%, #CDDC39 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            margin-bottom: 10px;
                        ">‚úÖ FlashPost Emergency UI</h1>
                        <p style="
                            font-size: 18px;
                            color: rgba(255, 255, 255, 0.9);
                            font-weight: 600;
                            margin-bottom: 10px;
                        ">JavaScript is alive and DOM is accessible!</p>
                        <p style="
                            font-size: 14px;
                            color: rgba(255, 255, 255, 0.7);
                            margin-bottom: 0;
                        ">Main UI failed to render, but core system is functional</p>
                    </div>
                    
                    <div style="
                        background: rgba(0, 0, 0, 0.2);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 30px;
                        text-align: left;
                    ">
                        <h3 style="
                            color: #4CAF50;
                            margin-bottom: 15px;
                            font-size: 16px;
                        ">üîç System Status</h3>
                        <div id="systemStatus" style="
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            line-height: 1.6;
                            color: rgba(255, 255, 255, 0.8);
                        "></div>
                    </div>
                    
                    <div style="
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        justify-content: center;
                        margin-bottom: 20px;
                    ">
                        <button id="reloadUIBtn" style="
                            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
                        ">üîÑ Reload UI</button>
                        
                        <button id="resetStateBtn" style="
                            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                        ">üîß Reset State</button>
                        
                        <button id="forceReloadBtn" style="
                            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                        ">üöÄ Force Reload</button>
                        
                        <button onclick="location.reload()" style="
                            background: linear-gradient(135deg, #9C27B0 0%, #673AB7 100%);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
                        ">üîô Back to Test</button>
                    </div>
                    
                    <div style="
                        background: rgba(255, 193, 7, 0.1);
                        border: 1px solid rgba(255, 193, 7, 0.3);
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 20px;
                    ">
                        <p style="
                            margin: 0;
                            font-size: 14px;
                            color: #FFC107;
                            font-weight: 600;
                        ">‚ö†Ô∏è Emergency Mode Active</p>
                        <p style="
                            margin: 5px 0 0 0;
                            font-size: 12px;
                            color: rgba(255, 255, 255, 0.8);
                        ">The main FlashPost UI failed to initialize, but the emergency system is working.</p>
                    </div>
                    
                    <div style="
                        font-size: 12px;
                        color: rgba(255, 255, 255, 0.5);
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        padding-top: 15px;
                    ">
                        <p style="margin: 0;">üîí Emergency Fallback UI v1.0</p>
                        <p style="margin: 5px 0 0 0;">Timestamp: <span id="timestamp"></span></p>
                    </div>
                `;
                
                document.body.appendChild(emergencyContainer);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                this.updateEmergencySystemStatus();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º timestamp
                document.getElementById('timestamp').textContent = new Date().toLocaleString();
                
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫
                this.bindEmergencyUIEvents();
                
                console.log('‚úÖ EMERGENCY FALLBACK: Emergency UI rendered successfully');
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –≤ emergency UI
            updateEmergencySystemStatus() {
                const statusElement = document.getElementById('systemStatus');
                if (!statusElement) return;
                
                const status = [];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                status.push(`‚úÖ JavaScript: Active`);
                status.push(`‚úÖ DOM: Accessible`);
                status.push(`‚úÖ Window: ${window.innerWidth}x${window.innerHeight}`);
                status.push(`${window.PREVIEW_MODE ? '‚úÖ' : '‚ùå'} Preview Mode: ${window.PREVIEW_MODE ? 'Active' : 'Inactive'}`);
                status.push(`${window.Telegram?.WebApp ? '‚úÖ' : '‚ö†Ô∏è'} Telegram WebApp: ${window.Telegram?.WebApp ? 'Available' : 'Mock'}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª–∏
                const modules = ['StateManager', 'Renderer', 'Editor', 'FlashPostApp'];
                modules.forEach(module => {
                    const available = typeof window[module] !== 'undefined';
                    status.push(`${available ? '‚úÖ' : '‚ùå'} ${module}: ${available ? 'Loaded' : 'Missing'}`);
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                status.push(`${window.flashPostApp ? '‚úÖ' : '‚ùå'} App Instance: ${window.flashPostApp ? 'Created' : 'Missing'}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    status.push(`‚úÖ LocalStorage: Available`);
                } catch (e) {
                    status.push(`‚ùå LocalStorage: Blocked`);
                }
                
                statusElement.innerHTML = status.join('<br>');
            }
            
            // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è emergency UI
            bindEmergencyUIEvents() {
                // –ö–Ω–æ–ø–∫–∞ Reload UI
                const reloadUIBtn = document.getElementById('reloadUIBtn');
                if (reloadUIBtn) {
                    reloadUIBtn.addEventListener('click', () => {
                        console.log('üîÑ EMERGENCY: Attempting UI reload...');
                        reloadUIBtn.textContent = 'üîÑ Reloading...';
                        reloadUIBtn.disabled = true;
                        
                        setTimeout(() => {
                            alert('‚úÖ UI Reload button works! In real app, this would restart the UI.');
                            reloadUIBtn.textContent = 'üîÑ Reload UI';
                            reloadUIBtn.disabled = false;
                        }, 1000);
                    });
                }
                
                // –ö–Ω–æ–ø–∫–∞ Reset State
                const resetStateBtn = document.getElementById('resetStateBtn');
                if (resetStateBtn) {
                    resetStateBtn.addEventListener('click', () => {
                        console.log('üîß EMERGENCY: Resetting application state...');
                        resetStateBtn.textContent = 'üîß Resetting...';
                        resetStateBtn.disabled = true;
                        
                        setTimeout(() => {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                            this.updateEmergencySystemStatus();
                            
                            resetStateBtn.textContent = '‚úÖ State Reset';
                            setTimeout(() => {
                                resetStateBtn.textContent = 'üîß Reset State';
                                resetStateBtn.disabled = false;
                            }, 1000);
                            
                            alert('‚úÖ State Reset button works! Application state would be cleared.');
                        }, 1000);
                    });
                }
                
                // –ö–Ω–æ–ø–∫–∞ Force Reload
                const forceReloadBtn = document.getElementById('forceReloadBtn');
                if (forceReloadBtn) {
                    forceReloadBtn.addEventListener('click', () => {
                        console.log('üöÄ EMERGENCY: Force reloading page...');
                        forceReloadBtn.textContent = 'üöÄ Reloading...';
                        forceReloadBtn.disabled = true;
                        
                        setTimeout(() => {
                            location.reload(true);
                        }, 500);
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã
                [reloadUIBtn, resetStateBtn, forceReloadBtn].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('mouseenter', () => {
                            if (!btn.disabled) {
                                btn.style.transform = 'translateY(-2px)';
                                btn.style.boxShadow = btn.style.boxShadow.replace('0.3', '0.5');
                            }
                        });
                        
                        btn.addEventListener('mouseleave', () => {
                            if (!btn.disabled) {
                                btn.style.transform = 'translateY(0)';
                                btn.style.boxShadow = btn.style.boxShadow.replace('0.5', '0.3');
                            }
                        });
                    }
                });
            }
        }
        
        window.FlashPostApp = FlashPostApp;
        
        // Test functions
        function addStatus(message, type = 'ok') {
            const statusDiv = document.getElementById('testStatus');
            const statusElement = document.createElement('div');
            statusElement.className = `status status-${type}`;
            statusElement.textContent = message;
            statusDiv.appendChild(statusElement);
        }
        
        function testRenderFailure() {
            addStatus('üö® Testing render failure scenario...', 'warning');
            window.testRenderFailure = true;
            window.testModulesAvailable = true;
            window.testMissingDOM = false;
            
            setTimeout(() => {
                const app = new FlashPostApp();
                app.renderApp();
            }, 500);
        }
        
        function testMissingModules() {
            addStatus('üì¶ Testing missing modules scenario...', 'warning');
            window.testRenderFailure = false;
            window.testModulesAvailable = false;
            window.testMissingDOM = false;
            
            setTimeout(() => {
                const app = new FlashPostApp();
                app.renderApp();
            }, 500);
        }
        
        function testMissingDOM() {
            addStatus('üîç Testing missing DOM scenario...', 'warning');
            window.testRenderFailure = false;
            window.testModulesAvailable = true;
            window.testMissingDOM = true;
            
            setTimeout(() => {
                const app = new FlashPostApp();
                app.renderApp();
            }, 500);
        }
        
        function testDirectEmergencyUI() {
            addStatus('‚úÖ Showing Emergency UI directly...', 'ok');
            
            setTimeout(() => {
                const app = new FlashPostApp();
                app.renderEmergencyFallbackUI();
            }, 500);
        }
        
        function resetTest() {
            location.reload();
        }
        
        // Set PREVIEW_MODE for testing
        window.PREVIEW_MODE = true;
        
        console.log('üß™ Emergency Fallback UI Test loaded');
    </script>
</body>
</html>