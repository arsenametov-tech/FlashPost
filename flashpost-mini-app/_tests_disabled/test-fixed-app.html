<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ FlashPost App</title>
    <link rel="stylesheet" href="app.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .test-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
        }
        
        .test-status {
            margin: 5px 0;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .test-status.success {
            background: #4CAF50;
        }
        
        .test-status.error {
            background: #f44336;
        }
        
        .test-status.warning {
            background: #ff9800;
        }
        
        .test-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .test-button:hover {
            background: #1976D2;
        }
        
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
            z-index: 9999;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        #app {
            display: none;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading">
        <div>
            <div>üöÄ FlashPost AI</div>
            <div style="font-size: 14px; margin-top: 10px; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏...</div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app"></div>

    <!-- –ü–∞–Ω–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="test-panel">
        <div style="font-weight: bold; margin-bottom: 10px;">üß™ –¢–µ—Å—Ç –ø–∞–Ω–µ–ª—å</div>
        <div id="moduleStatus"></div>
        <div style="margin: 10px 0;">
            <button class="test-button" onclick="testModules()">–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π</button>
            <button class="test-button" onclick="testStateManager()">–¢–µ—Å—Ç State</button>
            <button class="test-button" onclick="testRenderer()">–¢–µ—Å—Ç Renderer</button>
            <button class="test-button" onclick="testEditor()">–¢–µ—Å—Ç Editor</button>
        </div>
        <div style="margin: 10px 0;">
            <button class="test-button" onclick="testCallbacks()">–¢–µ—Å—Ç –∫–æ–ª–±—ç–∫–æ–≤</button>
            <button class="test-button" onclick="testMemoryLeaks()">–¢–µ—Å—Ç –ø–∞–º—è—Ç–∏</button>
            <button class="test-button" onclick="clearTests()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="testResults"></div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -->
    <script src="src/state.js"></script>
    <script src="src/renderer.js"></script>
    <script src="src/editor.js"></script>
    <script src="src/drag.js"></script>
    <script src="src/export.js"></script>
    <script src="src/ai.js"></script>
    <script src="src/templates.js"></script>
    <script src="src/app.js"></script>

    <script>
        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function addTestResult(message, type = 'success') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-status ${type}`;
            div.textContent = message;
            results.appendChild(div);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            if (results.children.length > 10) {
                results.removeChild(results.firstChild);
            }
        }

        function clearTests() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('moduleStatus').innerHTML = '';
        }

        function testModules() {
            clearTests();
            addTestResult('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π...', 'warning');
            
            const modules = [
                { name: 'StateManager', obj: window.StateManager },
                { name: 'Renderer', obj: window.Renderer },
                { name: 'Editor', obj: window.Editor },
                { name: 'DragManager', obj: window.DragManager },
                { name: 'ExportManager', obj: window.ExportManager },
                { name: 'AIManager', obj: window.AIManager },
                { name: 'TemplateManager', obj: window.TemplateManager },
                { name: 'FlashPostApp', obj: window.FlashPostApp }
            ];
            
            let loaded = 0;
            modules.forEach(module => {
                if (module.obj) {
                    addTestResult(`‚úÖ ${module.name} –∑–∞–≥—Ä—É–∂–µ–Ω`);
                    loaded++;
                } else {
                    addTestResult(`‚ùå ${module.name} –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω`, 'error');
                }
            });
            
            addTestResult(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loaded}/${modules.length} –º–æ–¥—É–ª–µ–π`, loaded === modules.length ? 'success' : 'error');
        }

        function testStateManager() {
            addTestResult('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ StateManager...', 'warning');
            
            try {
                if (!window.flashPostApp || !window.flashPostApp.state) {
                    addTestResult('‚ùå StateManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                    return;
                }
                
                const state = window.flashPostApp.state;
                
                // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–∞
                const slide = state.createSlide({ title: '–¢–µ—Å—Ç —Å–ª–∞–π–¥' });
                if (slide && slide.id) {
                    addTestResult('‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addTestResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–∞', 'error');
                }
                
                // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
                const block = state.createTextBlock(slide.id, { text: '–¢–µ—Å—Ç –±–ª–æ–∫' });
                if (block && block.id) {
                    addTestResult('‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addTestResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞', 'error');
                }
                
                // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
                const updated = state.updateTextBlockProperty(block.id, 'color', '#ff0000');
                if (updated) {
                    addTestResult('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addTestResult('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤', 'error');
                }
                
                // –¢–µ—Å—Ç –∫–æ–ª–±—ç–∫–æ–≤
                let callbackCalled = false;
                state.setPropertyChangeCallback(() => {
                    callbackCalled = true;
                });
                
                state.updateTextBlockProperty(block.id, 'size', 24);
                
                setTimeout(() => {
                    if (callbackCalled) {
                        addTestResult('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ–ª–±—ç–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    } else {
                        addTestResult('‚ùå –ö–æ–ª–±—ç–∫–∏ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è', 'error');
                    }
                }, 100);
                
            } catch (error) {
                addTestResult(`‚ùå –û—à–∏–±–∫–∞ StateManager: ${error.message}`, 'error');
            }
        }

        function testRenderer() {
            addTestResult('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Renderer...', 'warning');
            
            try {
                if (!window.flashPostApp || !window.flashPostApp.renderer) {
                    addTestResult('‚ùå Renderer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                    return;
                }
                
                const renderer = window.flashPostApp.renderer;
                
                // –¢–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                renderer.render();
                addTestResult('‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ DOM —Å–æ–∑–¥–∞–ª—Å—è
                const app = document.getElementById('app');
                if (app && app.children.length > 0) {
                    addTestResult('‚úÖ DOM —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã');
                } else {
                    addTestResult('‚ùå DOM –Ω–µ —Å–æ–∑–¥–∞–Ω', 'error');
                }
                
            } catch (error) {
                addTestResult(`‚ùå –û—à–∏–±–∫–∞ Renderer: ${error.message}`, 'error');
            }
        }

        function testEditor() {
            addTestResult('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Editor...', 'warning');
            
            try {
                if (!window.flashPostApp || !window.flashPostApp.editor) {
                    addTestResult('‚ùå Editor –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                    return;
                }
                
                const editor = window.flashPostApp.editor;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Editor –ø–æ–ª—É—á–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                if (editor.state && editor.renderer) {
                    addTestResult('‚úÖ Editor –ø–æ–ª—É—á–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏');
                } else {
                    addTestResult('‚ùå Editor –Ω–µ –ø–æ–ª—É—á–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏', 'error');
                }
                
                // –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
                if (typeof editor.cleanupEventHandlers === 'function') {
                    editor.cleanupEventHandlers();
                    addTestResult('‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addTestResult('‚ùå –ú–µ—Ç–æ–¥ –æ—á–∏—Å—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
                
            } catch (error) {
                addTestResult(`‚ùå –û—à–∏–±–∫–∞ Editor: ${error.message}`, 'error');
            }
        }

        function testCallbacks() {
            addTestResult('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–ª–±—ç–∫–æ–≤...', 'warning');
            
            try {
                if (!window.flashPostApp) {
                    addTestResult('‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'error');
                    return;
                }
                
                const state = window.flashPostApp.state;
                let callbacksWorking = 0;
                
                // –¢–µ—Å—Ç –∫–æ–ª–±—ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
                state.setPropertyChangeCallback((hookData) => {
                    if (hookData && hookData.blockId && hookData.property) {
                        callbacksWorking++;
                        addTestResult(`‚úÖ –ö–æ–ª–±—ç–∫ —Å–≤–æ–π—Å—Ç–≤–∞: ${hookData.property}`);
                    }
                });
                
                // –¢–µ—Å—Ç –∫–æ–ª–±—ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
                state.setModeChangeCallback((newMode, oldMode) => {
                    if (newMode && oldMode !== undefined) {
                        callbacksWorking++;
                        addTestResult(`‚úÖ –ö–æ–ª–±—ç–∫ —Ä–µ–∂–∏–º–∞: ${oldMode} ‚Üí ${newMode}`);
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                const slide = state.createSlide({ title: '–¢–µ—Å—Ç –∫–æ–ª–±—ç–∫–æ–≤' });
                const block = state.createTextBlock(slide.id, { text: '–¢–µ—Å—Ç' });
                
                // –í—ã–∑—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                state.updateTextBlockProperty(block.id, 'color', '#00ff00');
                state.setMode('preview');
                
                setTimeout(() => {
                    if (callbacksWorking >= 2) {
                        addTestResult('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ–ª–±—ç–∫–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    } else {
                        addTestResult(`‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç ${callbacksWorking}/2 –∫–æ–ª–±—ç–∫–æ–≤`, 'warning');
                    }
                }, 200);
                
            } catch (error) {
                addTestResult(`‚ùå –û—à–∏–±–∫–∞ –∫–æ–ª–±—ç–∫–æ–≤: ${error.message}`, 'error');
            }
        }

        function testMemoryLeaks() {
            addTestResult('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏...', 'warning');
            
            try {
                const editor = window.flashPostApp?.editor;
                if (!editor) {
                    addTestResult('‚ùå Editor –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                    return;
                }
                
                // –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
                if (typeof editor.destroy === 'function') {
                    editor.destroy();
                    addTestResult('‚úÖ –ú–µ—Ç–æ–¥ destroy() —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                } else {
                    addTestResult('‚ùå –ú–µ—Ç–æ–¥ destroy() –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—á–∏—Å—Ç–∫—É –∫–æ–ª–±—ç–∫–æ–≤
                const state = window.flashPostApp.state;
                state.setPropertyChangeCallback(null);
                state.setModeChangeCallback(null);
                addTestResult('‚úÖ –ö–æ–ª–±—ç–∫–∏ –æ—á–∏—â–µ–Ω—ã');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—á–∏—Å—Ç–∫—É —Å—Ç–∏–ª–µ–π —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                const renderer = window.flashPostApp.renderer;
                if (typeof renderer.cleanupTextBlockEffects === 'function') {
                    renderer.cleanupTextBlockEffects('test-block-id');
                    addTestResult('‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∏–ª–µ–π —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    addTestResult('‚ùå –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∏–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
                
            } catch (error) {
                addTestResult(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏: ${error.message}`, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª–µ–π
        function updateModuleStatus() {
            const status = document.getElementById('moduleStatus');
            const app = window.flashPostApp;
            
            if (app) {
                status.innerHTML = `
                    <div class="test-status success">‚úÖ App: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</div>
                    <div class="test-status ${app.state ? 'success' : 'error'}">
                        ${app.state ? '‚úÖ' : '‚ùå'} State: ${app.state ? 'OK' : '–û—à–∏–±–∫–∞'}
                    </div>
                    <div class="test-status ${app.renderer ? 'success' : 'error'}">
                        ${app.renderer ? '‚úÖ' : '‚ùå'} Renderer: ${app.renderer ? 'OK' : '–û—à–∏–±–∫–∞'}
                    </div>
                    <div class="test-status ${app.editor ? 'success' : 'error'}">
                        ${app.editor ? '‚úÖ' : '‚ùå'} Editor: ${app.editor ? 'OK' : '–û—à–∏–±–∫–∞'}
                    </div>
                `;
            } else {
                status.innerHTML = '<div class="test-status error">‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>';
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                updateModuleStatus();
                addTestResult('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –≥–æ—Ç–æ–≤–∞');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –º–æ–¥—É–ª–µ–π
                setTimeout(() => {
                    testModules();
                }, 1000);
            }, 2000);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(updateModuleStatus, 5000);
    </script>
</body>
</html>