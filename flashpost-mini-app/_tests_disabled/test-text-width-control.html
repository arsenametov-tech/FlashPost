<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìè Text Width Control Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0f0f14 0%, #1a1a2e 50%, #16213e 100%); 
            color: #fff; 
            font-family: Arial, sans-serif; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .title { font-size: 32px; color: #ff6b35; margin-bottom: 10px; }
        .subtitle { color: #888; }
        .test-card { 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 20px 0; 
            border: 1px solid rgba(255,107,53,0.3); 
        }
        .btn { 
            background: linear-gradient(45deg, #ff6b35, #f7931e); 
            color: #000; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px; 
            font-weight: bold; 
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input, .slider { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 8px; 
            padding: 12px; 
            color: white; 
            margin: 10px 0; 
        }
        .slider { 
            width: 100%; 
            height: 6px; 
            padding: 0; 
            appearance: none; 
            cursor: pointer; 
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }
        .log { 
            background: #000; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 15px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            margin: 10px 0; 
        }
        .preview-area { 
            background: rgba(0,0,0,0.3); 
            border-radius: 8px; 
            padding: 20px; 
            margin: 10px 0; 
            min-height: 200px; 
            position: relative; 
        }
        .text-block-preview { 
            background: rgba(255,107,53,0.2); 
            border: 2px solid #ff6b35; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
            color: white; 
            text-align: center; 
            transition: all 0.3s ease; 
            position: relative; 
        }
        .text-block-preview.active { 
            border-color: #00ff88; 
            background: rgba(0,255,136,0.2); 
        }
        .width-display { 
            position: absolute; 
            top: -10px; 
            right: 10px; 
            background: #ff6b35; 
            color: #000; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: bold; 
        }
        .control-group { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin: 15px 0; 
        }
        .control-label { 
            min-width: 100px; 
            font-weight: bold; 
        }
        .width-value { 
            min-width: 60px; 
            text-align: center; 
            background: rgba(255,107,53,0.2); 
            padding: 8px; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .stats { 
            background: rgba(0,136,255,0.2); 
            border: 1px solid #0088ff; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
        }
        .stat-item { 
            text-align: center; 
        }
        .stat-value { 
            font-size: 24px; 
            font-weight: bold; 
            color: #0088ff; 
        }
        .stat-label { 
            font-size: 12px; 
            color: #888; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üìè Text Width Control Test</h1>
            <p class="subtitle">Testing text block width control system (20-100%)</p>
        </div>
        
        <div class="test-card">
            <h2>üéõÔ∏è Width Controls</h2>
            
            <div class="control-group">
                <label class="control-label">Width Slider:</label>
                <input type="range" id="widthSlider" class="slider" min="20" max="100" value="80" step="1">
                <div class="width-value" id="widthValue">80%</div>
            </div>
            
            <div class="control-group">
                <label class="control-label">Width Input:</label>
                <input type="number" id="widthInput" class="input" min="20" max="100" value="80" style="width: 100px;">
                <span>%</span>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="createSampleBlocks()">üìù Create Sample Blocks</button>
                <button class="btn" onclick="applyToAll()">üîÑ Apply to All</button>
                <button class="btn" onclick="resetWidths()">‚Ü©Ô∏è Reset to 80%</button>
                <button class="btn" onclick="updateStats()">üìä Update Stats</button>
            </div>
        </div>

        <div class="test-card">
            <h2>üìä Width Statistics</h2>
            <div id="statsContainer" class="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statMin">-</div>
                        <div class="stat-label">Min Width</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statMax">-</div>
                        <div class="stat-label">Max Width</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statAvg">-</div>
                        <div class="stat-label">Average</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCount">-</div>
                        <div class="stat-label">Blocks</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-card">
            <h2>üñºÔ∏è Live Preview</h2>
            <div id="previewArea" class="preview-area">
                <p style="text-align: center; color: #888; margin-top: 80px;">
                    Click "Create Sample Blocks" to start testing
                </p>
            </div>
        </div>

        <div class="test-card">
            <h2>üìã Console Log</h2>
            <div id="consoleLog" class="log">Text Width Control Test ready...<br></div>
        </div>
    </div>

    <!-- Load modules -->
    <script src="src/state.js"></script>

    <script>
        // Initialize state manager
        let stateManager;
        let activeBlockId = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = { error: '‚ùå', success: '‚úÖ', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const colors = { error: '#ff4444', success: '#00ff88', warning: '#ffc107', info: '#0088ff' };
            
            const logElement = document.getElementById('consoleLog');
            if (logElement) {
                logElement.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${icons[type]} ${message}</span><br>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(`[${timestamp}] ${message}`);
        }

        function createSampleBlocks() {
            try {
                log('Creating sample text blocks...', 'info');
                
                // Create a sample slide
                const slide = stateManager.createSlide({
                    title: 'Width Test Slide',
                    text: 'Testing text width controls'
                });
                
                // Create sample text blocks with different widths
                const sampleTexts = [
                    'Short text block',
                    'This is a medium length text block for testing width controls',
                    'This is a very long text block that demonstrates how width control affects text wrapping and layout in the slide editor'
                ];
                
                const sampleWidths = [60, 80, 100];
                
                sampleTexts.forEach((text, index) => {
                    const block = stateManager.createTextBlock(slide.id, {
                        text: text,
                        x: 50,
                        y: 20 + (index * 25),
                        width: sampleWidths[index],
                        font: 'Inter',
                        size: 16,
                        weight: 600,
                        color: '#ffffff'
                    });
                    
                    log(`Created block ${index + 1}: ${block.id} (width: ${sampleWidths[index]}%)`, 'success');
                });
                
                // Set first slide as active
                stateManager.setCurrentSlideIndex(0);
                
                // Render preview
                renderPreview();
                updateStats();
                
                log(`Sample blocks created successfully`, 'success');
                
            } catch (error) {
                log(`Error creating sample blocks: ${error.message}`, 'error');
            }
        }

        function renderPreview() {
            const previewArea = document.getElementById('previewArea');
            const activeSlide = stateManager.getActiveSlide();
            
            if (!activeSlide || !activeSlide.textBlocks || activeSlide.textBlocks.length === 0) {
                previewArea.innerHTML = '<p style="text-align: center; color: #888; margin-top: 80px;">No text blocks to display</p>';
                return;
            }
            
            previewArea.innerHTML = '';
            
            activeSlide.textBlocks.forEach((block, index) => {
                const blockEl = document.createElement('div');
                blockEl.className = 'text-block-preview';
                blockEl.id = `preview_${block.id}`;
                blockEl.style.width = `${block.width}%`;
                blockEl.innerHTML = `
                    <div class="width-display">${block.width}%</div>
                    ${block.text}
                `;
                
                blockEl.addEventListener('click', () => {
                    selectBlock(block.id);
                });
                
                previewArea.appendChild(blockEl);
            });
            
            log(`Rendered ${activeSlide.textBlocks.length} text blocks in preview`, 'info');
        }

        function selectBlock(blockId) {
            activeBlockId = blockId;
            
            // Update UI
            document.querySelectorAll('.text-block-preview').forEach(el => {
                el.classList.remove('active');
            });
            
            const selectedEl = document.getElementById(`preview_${blockId}`);
            if (selectedEl) {
                selectedEl.classList.add('active');
            }
            
            // Update controls with current width
            const width = stateManager.getTextBlockWidth(blockId);
            if (width !== null) {
                document.getElementById('widthSlider').value = width;
                document.getElementById('widthInput').value = width;
                document.getElementById('widthValue').textContent = `${width}%`;
            }
            
            log(`Selected block: ${blockId} (width: ${width}%)`, 'info');
        }

        function updateWidth(newWidth) {
            if (!activeBlockId) {
                log('No block selected for width update', 'warning');
                return;
            }
            
            try {
                const success = stateManager.updateTextBlockWidth(activeBlockId, newWidth);
                
                if (success) {
                    // Update preview
                    const previewEl = document.getElementById(`preview_${activeBlockId}`);
                    if (previewEl) {
                        previewEl.style.width = `${newWidth}%`;
                        previewEl.querySelector('.width-display').textContent = `${newWidth}%`;
                    }
                    
                    // Update controls
                    document.getElementById('widthSlider').value = newWidth;
                    document.getElementById('widthInput').value = newWidth;
                    document.getElementById('widthValue').textContent = `${newWidth}%`;
                    
                    updateStats();
                    log(`Width updated to ${newWidth}%`, 'success');
                } else {
                    log('Failed to update width', 'error');
                }
            } catch (error) {
                log(`Error updating width: ${error.message}`, 'error');
            }
        }

        function applyToAll() {
            const width = parseInt(document.getElementById('widthSlider').value);
            
            try {
                const success = stateManager.updateAllBlocksWidth(width);
                
                if (success) {
                    renderPreview();
                    updateStats();
                    log(`Applied width ${width}% to all blocks`, 'success');
                } else {
                    log('Failed to apply width to all blocks', 'error');
                }
            } catch (error) {
                log(`Error applying width to all: ${error.message}`, 'error');
            }
        }

        function resetWidths() {
            try {
                const success = stateManager.resetAllBlocksWidth(80);
                
                if (success) {
                    document.getElementById('widthSlider').value = 80;
                    document.getElementById('widthInput').value = 80;
                    document.getElementById('widthValue').textContent = '80%';
                    
                    renderPreview();
                    updateStats();
                    log('Reset all widths to 80%', 'success');
                } else {
                    log('Failed to reset widths', 'error');
                }
            } catch (error) {
                log(`Error resetting widths: ${error.message}`, 'error');
            }
        }

        function updateStats() {
            try {
                const stats = stateManager.getSlideWidthStats();
                
                if (stats) {
                    document.getElementById('statMin').textContent = `${stats.min}%`;
                    document.getElementById('statMax').textContent = `${stats.max}%`;
                    document.getElementById('statAvg').textContent = `${stats.average}%`;
                    document.getElementById('statCount').textContent = stats.count;
                    
                    log(`Stats updated: ${stats.count} blocks, avg: ${stats.average}%`, 'info');
                } else {
                    document.getElementById('statMin').textContent = '-';
                    document.getElementById('statMax').textContent = '-';
                    document.getElementById('statAvg').textContent = '-';
                    document.getElementById('statCount').textContent = '0';
                }
            } catch (error) {
                log(`Error updating stats: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('widthSlider').addEventListener('input', (e) => {
            const width = parseInt(e.target.value);
            document.getElementById('widthValue').textContent = `${width}%`;
            document.getElementById('widthInput').value = width;
            updateWidth(width);
        });

        document.getElementById('widthInput').addEventListener('input', (e) => {
            const width = Math.max(20, Math.min(100, parseInt(e.target.value) || 20));
            document.getElementById('widthSlider').value = width;
            document.getElementById('widthValue').textContent = `${width}%`;
            updateWidth(width);
        });

        // Listen for width change events
        document.addEventListener('textBlockWidthChanged', (event) => {
            log(`Width change event: Block ${event.detail.blockId} ‚Üí ${event.detail.newValue}%`, 'info');
        });

        document.addEventListener('batchTextBlockWidthChanged', (event) => {
            log(`Batch width change: ${event.detail.blockIds.length} blocks ‚Üí ${event.detail.newValue}%`, 'info');
        });

        // Initialize on page load
        window.addEventListener('load', () => {
            try {
                stateManager = new StateManager();
                log('StateManager initialized', 'success');
                log('Text Width Control Test ready', 'success');
                
                // Set up property change callback
                stateManager.setPropertyChangeCallback((data) => {
                    if (data.property === 'width') {
                        log(`Property change callback: ${data.property} ‚Üí ${data.newValue}`, 'info');
                    }
                });
                
            } catch (error) {
                log(`Initialization error: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>