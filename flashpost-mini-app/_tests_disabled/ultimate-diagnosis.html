<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ultimate Diagnosis - FlashPost</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap&subset=latin,cyrillic" rel="stylesheet">
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            height: 100vh;
            height: 100dvh;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            background-size: 400% 400%;
            animation: gradientShift 4s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            animation: pulse 2s ease-in-out infinite;
            font-size: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* Ultimate Diagnosis Styles */
        .ultimate-diagnosis {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 20000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .diagnosis-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 2px solid #00ff00;
        }
        
        .diagnosis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .diagnosis-section {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
        }
        
        .section-title {
            color: #ffff00;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .diagnosis-log {
            margin: 3px 0;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .success { 
            color: #00ff00; 
            background: rgba(0, 255, 0, 0.1);
        }
        .error { 
            color: #ff0000; 
            background: rgba(255, 0, 0, 0.1);
        }
        .warning { 
            color: #ffaa00; 
            background: rgba(255, 170, 0, 0.1);
        }
        .info {
            color: #00aaff;
            background: rgba(0, 170, 255, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: bold;
            font-size: 12px;
        }
        
        .final-result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .result-success {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            color: #00ff00;
        }
        
        .result-failure {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            color: #ff0000;
        }
        
        .result-partial {
            background: rgba(255, 170, 0, 0.2);
            border: 2px solid #ffaa00;
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–∑—ã—Ä—å–∫–∏ -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading" id="loading">
        <div class="loading-icon">‚ö°</div>
        <div class="loading-text">FlashPost Mini App</div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app" id="app">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>

    <!-- Ultimate Diagnosis Panel -->
    <div class="ultimate-diagnosis" id="ultimate-diagnosis">
        <div class="diagnosis-header">
            <h1>üîç ULTIMATE FLASHPOST DIAGNOSIS</h1>
            <p>–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã</p>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress">0%</div>
            </div>
        </div>
        
        <div class="diagnosis-grid">
            <div class="diagnosis-section">
                <div class="section-title">üì¶ Module Loading</div>
                <div id="module-logs"></div>
            </div>
            
            <div class="diagnosis-section">
                <div class="section-title">üåê DOM Elements</div>
                <div id="dom-logs"></div>
            </div>
            
            <div class="diagnosis-section">
                <div class="section-title">üöÄ App Initialization</div>
                <div id="init-logs"></div>
            </div>
            
            <div class="diagnosis-section">
                <div class="section-title">‚ö†Ô∏è Errors & Warnings</div>
                <div id="error-logs"></div>
            </div>
            
            <div class="diagnosis-section">
                <div class="section-title">üìä Performance</div>
                <div id="performance-logs"></div>
            </div>
            
            <div class="diagnosis-section">
                <div class="section-title">üîß System Info</div>
                <div id="system-logs"></div>
            </div>
        </div>
        
        <div class="final-result" id="final-result">
            üîÑ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...
        </div>
    </div>

    <!-- –°—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã -->
    <link rel="stylesheet" href="app.css">
    
    <script>
        // Ultimate Diagnosis System
        class UltimateDiagnosis {
            constructor() {
                this.startTime = Date.now();
                this.logs = {
                    module: [],
                    dom: [],
                    init: [],
                    error: [],
                    performance: [],
                    system: []
                };
                this.progress = 0;
                this.totalSteps = 20;
                this.currentStep = 0;
                
                this.init();
            }
            
            init() {
                this.addSystemLog('üöÄ Ultimate Diagnosis Started');
                this.addSystemLog(`‚è∞ Start Time: ${new Date().toLocaleString()}`);
                this.addSystemLog(`üåê URL: ${window.location.href}`);
                this.addSystemLog(`üì± User Agent: ${navigator.userAgent.substring(0, 50)}...`);
                
                this.setupErrorHandling();
                this.startDiagnosis();
            }
            
            setupErrorHandling() {
                const originalError = console.error;
                const originalWarn = console.warn;
                const originalLog = console.log;
                
                console.error = (...args) => {
                    const message = args.join(' ');
                    this.addErrorLog(`‚ùå ${message}`, 'error');
                    originalError.apply(console, args);
                };
                
                console.warn = (...args) => {
                    const message = args.join(' ');
                    this.addErrorLog(`‚ö†Ô∏è ${message}`, 'warning');
                    originalWarn.apply(console, args);
                };
                
                console.log = (...args) => {
                    const message = args.join(' ');
                    if (message.includes('FlashPost') || message.includes('–º–æ–¥—É–ª') || message.includes('DOM') || message.includes('–∏–Ω–∏—Ü–∏–∞–ª–∏–∑')) {
                        if (message.includes('‚ùå')) {
                            this.addInitLog(message, 'error');
                        } else if (message.includes('‚úÖ')) {
                            this.addInitLog(message, 'success');
                        } else if (message.includes('‚è≥') || message.includes('‚ö†Ô∏è')) {
                            this.addInitLog(message, 'warning');
                        } else {
                            this.addInitLog(message, 'info');
                        }
                    }
                    originalLog.apply(console, args);
                };
                
                window.addEventListener('error', (event) => {
                    this.addErrorLog(`‚ùå RUNTIME ERROR: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    this.addErrorLog(`‚ùå PROMISE REJECTION: ${event.reason}`, 'error');
                });
            }
            
            addLog(category, message, type = 'info') {
                const timestamp = Date.now() - this.startTime;
                const logEntry = {
                    timestamp,
                    message,
                    type,
                    time: new Date().toLocaleTimeString()
                };
                
                this.logs[category].push(logEntry);
                this.updateLogDisplay(category, logEntry);
            }
            
            addModuleLog(message, type = 'info') { this.addLog('module', message, type); }
            addDomLog(message, type = 'info') { this.addLog('dom', message, type); }
            addInitLog(message, type = 'info') { this.addLog('init', message, type); }
            addErrorLog(message, type = 'error') { this.addLog('error', message, type); }
            addPerformanceLog(message, type = 'info') { this.addLog('performance', message, type); }
            addSystemLog(message, type = 'info') { this.addLog('system', message, type); }
            
            updateLogDisplay(category, logEntry) {
                const container = document.getElementById(`${category}-logs`);
                if (container) {
                    const div = document.createElement('div');
                    div.className = `diagnosis-log ${logEntry.type}`;
                    div.innerHTML = `[+${logEntry.timestamp}ms] ${logEntry.message}`;
                    container.appendChild(div);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
                    if (container.children.length > 20) {
                        container.removeChild(container.firstChild);
                    }
                }
            }
            
            updateProgress(step, message) {
                this.currentStep = step;
                this.progress = Math.round((step / this.totalSteps) * 100);
                
                const progressBar = document.getElementById('overall-progress');
                if (progressBar) {
                    progressBar.style.width = `${this.progress}%`;
                    progressBar.textContent = `${this.progress}% - ${message}`;
                }
                
                this.addPerformanceLog(`üìä Progress: ${this.progress}% - ${message}`);
            }
            
            async startDiagnosis() {
                this.updateProgress(1, 'Checking DOM State');
                await this.checkDOMState();
                
                this.updateProgress(3, 'Checking Required Elements');
                await this.checkRequiredElements();
                
                this.updateProgress(5, 'Testing Module Loading');
                await this.testModuleLoading();
                
                this.updateProgress(10, 'Waiting for App Initialization');
                await this.waitForAppInitialization();
                
                this.updateProgress(15, 'Testing App Functionality');
                await this.testAppFunctionality();
                
                this.updateProgress(18, 'Generating Performance Report');
                await this.generatePerformanceReport();
                
                this.updateProgress(20, 'Diagnosis Complete');
                this.generateFinalReport();
            }
            
            async checkDOMState() {
                this.addDomLog(`üìÑ DOM Ready State: ${document.readyState}`, 
                    document.readyState === 'complete' ? 'success' : 'warning');
                
                if (document.readyState === 'loading') {
                    this.addDomLog('‚è≥ Waiting for DOM to load...', 'warning');
                    await new Promise(resolve => {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', resolve);
                        } else {
                            resolve();
                        }
                    });
                    this.addDomLog('‚úÖ DOM loaded', 'success');
                }
            }
            
            async checkRequiredElements() {
                const requiredElements = ['app', 'loading'];
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        this.addDomLog(`‚úÖ #${elementId} element found`, 'success');
                    } else {
                        this.addDomLog(`‚ùå #${elementId} element NOT found`, 'error');
                    }
                });
            }
            
            async testModuleLoading() {
                const requiredModules = [
                    'StateManager', 'Renderer', 'Editor', 'DragManager',
                    'ExportManager', 'AIManager', 'TemplateManager', 'FlashPostApp'
                ];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª–∏ –∫–∞–∂–¥—ã–µ 500–º—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥
                for (let i = 0; i < 10; i++) {
                    let loadedCount = 0;
                    
                    requiredModules.forEach(module => {
                        if (typeof window[module] !== 'undefined') {
                            if (!this.logs.module.find(log => log.message.includes(`‚úÖ ${module}`))) {
                                this.addModuleLog(`‚úÖ ${module} loaded`, 'success');
                            }
                            loadedCount++;
                        }
                    });
                    
                    this.addModuleLog(`üìä Modules loaded: ${loadedCount}/${requiredModules.length}`, 
                        loadedCount === requiredModules.length ? 'success' : 'warning');
                    
                    if (loadedCount === requiredModules.length) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            async waitForAppInitialization() {
                // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ 10 —Å–µ–∫—É–Ω–¥
                for (let i = 0; i < 20; i++) {
                    if (typeof window.flashPostApp !== 'undefined') {
                        this.addInitLog('‚úÖ FlashPostApp instance created!', 'success');
                        
                        if (window.flashPostApp.state) {
                            this.addInitLog('‚úÖ State manager available', 'success');
                            try {
                                const mode = window.flashPostApp.state.getMode();
                                this.addInitLog(`üéØ Current mode: ${mode}`, 'success');
                            } catch (error) {
                                this.addInitLog(`‚ùå Error getting mode: ${error.message}`, 'error');
                            }
                        }
                        
                        if (window.flashPostApp.renderer) {
                            this.addInitLog('‚úÖ Renderer available', 'success');
                        }
                        
                        break;
                    } else {
                        if (i % 4 === 0) { // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                            this.addInitLog(`‚è≥ Waiting for app initialization... (${i/2}s)`, 'warning');
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                if (typeof window.flashPostApp === 'undefined') {
                    this.addInitLog('‚ùå FlashPostApp failed to initialize after 10 seconds', 'error');
                }
            }
            
            async testAppFunctionality() {
                if (typeof window.flashPostApp !== 'undefined') {
                    try {
                        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                        const slidesCount = window.flashPostApp.state.getSlidesCount();
                        this.addInitLog(`üìä Slides count: ${slidesCount}`, 'info');
                        
                        const mode = window.flashPostApp.state.getMode();
                        this.addInitLog(`üéØ App mode: ${mode}`, 'info');
                        
                        this.addInitLog('‚úÖ Basic functionality test passed', 'success');
                    } catch (error) {
                        this.addInitLog(`‚ùå Functionality test failed: ${error.message}`, 'error');
                    }
                } else {
                    this.addInitLog('‚ùå Cannot test functionality - app not initialized', 'error');
                }
            }
            
            async generatePerformanceReport() {
                const totalTime = Date.now() - this.startTime;
                this.addPerformanceLog(`‚è±Ô∏è Total diagnosis time: ${totalTime}ms`);
                
                const errorCount = this.logs.error.length;
                const warningCount = this.logs.error.filter(log => log.type === 'warning').length;
                
                this.addPerformanceLog(`üìä Total errors: ${errorCount}`);
                this.addPerformanceLog(`‚ö†Ô∏è Total warnings: ${warningCount}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                if (totalTime < 5000) {
                    this.addPerformanceLog('‚úÖ Good performance (< 5s)', 'success');
                } else if (totalTime < 10000) {
                    this.addPerformanceLog('‚ö†Ô∏è Moderate performance (5-10s)', 'warning');
                } else {
                    this.addPerformanceLog('‚ùå Poor performance (> 10s)', 'error');
                }
            }
            
            generateFinalReport() {
                const totalErrors = this.logs.error.filter(log => log.type === 'error').length;
                const totalWarnings = this.logs.error.filter(log => log.type === 'warning').length;
                const appInitialized = typeof window.flashPostApp !== 'undefined';
                const totalTime = Date.now() - this.startTime;
                
                const finalResult = document.getElementById('final-result');
                
                let resultClass, resultText;
                
                if (appInitialized && totalErrors === 0) {
                    resultClass = 'result-success';
                    resultText = 'üéâ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–°–ü–ï–®–ù–ê!\n‚úÖ FlashPostApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                } else if (appInitialized && totalErrors < 3) {
                    resultClass = 'result-partial';
                    resultText = `‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–´–ô –£–°–ü–ï–•\n‚úÖ FlashPostApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${totalErrors}`;
                } else {
                    resultClass = 'result-failure';
                    resultText = `‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–í–ê–õ–ï–ù–ê\n${appInitialized ? '‚úÖ' : '‚ùå'} FlashPostApp ${appInitialized ? '–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'}\n‚ùå –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: ${totalErrors}`;
                }
                
                finalResult.className = `final-result ${resultClass}`;
                finalResult.innerHTML = `
                    ${resultText}<br><br>
                    üìä –í—Ä–µ–º—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${totalTime}ms<br>
                    ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: ${totalWarnings}<br>
                    üîç –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫: ${this.totalSteps}
                `;
                
                // –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log('='.repeat(60));
                console.log('ULTIMATE FLASHPOST DIAGNOSIS REPORT');
                console.log('='.repeat(60));
                console.log(`Status: ${appInitialized ? 'SUCCESS' : 'FAILURE'}`);
                console.log(`App Initialized: ${appInitialized}`);
                console.log(`Total Errors: ${totalErrors}`);
                console.log(`Total Warnings: ${totalWarnings}`);
                console.log(`Diagnosis Time: ${totalTime}ms`);
                console.log('='.repeat(60));
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º Ultimate Diagnosis
        let ultimateDiagnosis;
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                ultimateDiagnosis = new UltimateDiagnosis();
            });
        } else {
            ultimateDiagnosis = new UltimateDiagnosis();
        }
    </script>
    
    <!-- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ -->
    <script src="src/state.js" defer></script>
    <script src="src/renderer.js" defer></script>
    <script src="src/editor.js" defer></script>
    <script src="src/drag.js" defer></script>
    <script src="src/export.js" defer></script>
    <script src="src/ai.js" defer></script>
    <script src="src/template-manager.js" defer></script>
    <script src="src/app.js" defer></script>
</body>
</html>