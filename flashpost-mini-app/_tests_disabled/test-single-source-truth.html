<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç Single Source of Truth Architecture</title>
    <link rel="stylesheet" href="app.css">
    <style>
        .test-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 12px;
            max-width: 300px;
        }
        .test-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #833ab4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .test-button:hover {
            background: #9d4edd;
        }
        .test-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-success {
            background: #28a745;
            color: white;
        }
        .test-error {
            background: #dc3545;
            color: white;
        }
        .test-info {
            background: #17a2b8;
            color: white;
        }
        .architecture-status {
            background: #6f42c1;
            color: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="loading" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üß™</div>
            <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Single Source of Truth</h2>
            <div class="loading-spinner"></div>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏...</p>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" style="display: none;"></div>

    <!-- –ü–∞–Ω–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="test-controls">
        <h3>üß™ –¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π</h3>
        
        <div class="architecture-status">
            <strong>üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</strong><br>
            Single Source of Truth ‚úÖ<br>
            –¢–æ–ª—å–∫–æ StateManager –º—É—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
        </div>

        <button class="test-button" onclick="testAddTextBlock()">
            ‚ûï –¢–µ—Å—Ç: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
        </button>
        
        <button class="test-button" onclick="testEditText()">
            ‚úçÔ∏è –¢–µ—Å—Ç: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        </button>
        
        <button class="test-button" onclick="testDragText()">
            üñ± –¢–µ—Å—Ç: Drag & Drop
        </button>
        
        <button class="test-button" onclick="testResizeWidth()">
            üìê –¢–µ—Å—Ç: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã
        </button>
        
        <button class="test-button" onclick="testStateConsistency()">
            üîç –¢–µ—Å—Ç: –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        </button>
        
        <button class="test-button" onclick="runAllTests()">
            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
        </button>
        
        <button class="test-button" onclick="resetToEditMode()">
            üîÑ –°–±—Ä–æ—Å –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        </button>

        <div id="testResults"></div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
    <script src="src/state.js"></script>
    <script src="src/renderer.js"></script>
    <script src="src/editor.js"></script>
    <script src="src/drag.js"></script>
    <script src="src/export.js"></script>
    <script src="src/ai.js"></script>
    <script src="src/templates.js"></script>
    <script src="src/app.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let testResults = [];
        let app = null;

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function logTest(testName, success, message) {
            const result = {
                test: testName,
                success: success,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('testResults');
            const statusClass = success ? 'test-success' : 'test-error';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            resultsDiv.innerHTML += `
                <div class="test-status ${statusClass}">
                    ${icon} ${testName}<br>
                    <small>${message}</small><br>
                    <small>${result.timestamp}</small>
                </div>
            `;
            
            console.log(`${icon} ${testName}: ${message}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function initTestApp() {
            try {
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                app = window.flashPostApp;
                
                if (!app) {
                    throw new Error('FlashPostApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                }

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥
                const testSlide = app.state.createSlide({
                    title: '–¢–µ—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥',
                    text: '–¢–µ—Å—Ç Single Source of Truth',
                    background: {
                        type: 'color',
                        color: '#833ab4'
                    }
                });

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
                const testBlock = app.state.createTextBlock(testSlide.id, {
                    text: '–¢–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–∫',
                    x: 50,
                    y: 30,
                    width: 60,
                    font: 'Inter',
                    size: 24,
                    color: '#ffffff'
                });

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                app.enterEditMode();
                
                logTest('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', true, '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
                
            } catch (error) {
                logTest('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
        function testAddTextBlock() {
            try {
                const initialBlocksCount = app.state.getActiveSlide()?.textBlocks.length || 0;
                console.log(`üìä –ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤: ${initialBlocksCount}`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ —á–µ—Ä–µ–∑ StateManager
                const newBlock = app.state.addTextBlock();
                
                if (!newBlock) {
                    throw new Error('–ë–ª–æ–∫ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω');
                }

                const finalBlocksCount = app.state.getActiveSlide()?.textBlocks.length || 0;
                console.log(`üìä –§–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤: ${finalBlocksCount}`);
                
                if (finalBlocksCount === initialBlocksCount + 1) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–ª–æ–∫ –ø–æ—è–≤–∏–ª—Å—è –≤ DOM
                    setTimeout(() => {
                        const blockInDOM = document.querySelector(`[data-block-id="${newBlock.id}"]`);
                        const allBlocks = document.querySelectorAll('[data-block-id]');
                        
                        console.log(`üîç –ü–æ–∏—Å–∫ –±–ª–æ–∫–∞ ${newBlock.id} –≤ DOM...`);
                        console.log(`üîç –í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤ –≤ DOM: ${allBlocks.length}`);
                        console.log(`üîç –ë–ª–æ–∫–∏ –≤ DOM:`, Array.from(allBlocks).map(el => el.dataset.blockId));
                        
                        if (blockInDOM) {
                            logTest('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞', true, `–ë–ª–æ–∫ ${newBlock.id} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ DOM`);
                        } else {
                            logTest('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞', false, `–ë–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –≤ DOM. –í—Å–µ–≥–æ –≤ DOM: ${allBlocks.length}`);
                        }
                    }, 200);
                } else {
                    throw new Error(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å: –±—ã–ª–æ ${initialBlocksCount}, —Å—Ç–∞–ª–æ ${finalBlocksCount}`);
                }
                
            } catch (error) {
                logTest('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –¢–µ—Å—Ç 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        function testEditText() {
            try {
                const activeSlide = app.state.getActiveSlide();
                if (!activeSlide || activeSlide.textBlocks.length === 0) {
                    throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞ –∏–ª–∏ –±–ª–æ–∫–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                }

                const blockId = activeSlide.textBlocks[0].id;
                const originalText = activeSlide.textBlocks[0].text;
                const newText = '–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ' + Date.now();

                console.log(`üìù –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞ ${blockId}: "${originalText}" ‚Üí "${newText}"`);

                // –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ StateManager
                const success = app.state.updateTextBlockProperty(blockId, 'text', newText);
                
                if (!success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const updatedSlide = app.state.getActiveSlide();
                const updatedBlock = updatedSlide.textBlocks.find(b => b.id === blockId);
                
                console.log(`üîç –¢–µ–∫—Å—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: "${updatedBlock.text}"`);
                
                if (updatedBlock.text === newText) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const blockInDOM = document.querySelector(`[data-block-id="${blockId}"]`);
                        
                        if (blockInDOM) {
                            const domText = blockInDOM.textContent || blockInDOM.innerText;
                            console.log(`üîç –¢–µ–∫—Å—Ç –≤ DOM: "${domText}"`);
                            
                            if (domText.includes(newText) || domText === newText) {
                                logTest('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞', true, `–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω: "${originalText}" ‚Üí "${newText}"`);
                            } else {
                                logTest('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞', false, `–¢–µ–∫—Å—Ç –∏–∑–º–µ–Ω–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è –≤ DOM. DOM: "${domText}", –û–∂–∏–¥–∞–ª–æ—Å—å: "${newText}"`);
                            }
                        } else {
                            logTest('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞', false, `–ë–ª–æ–∫ ${blockId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM`);
                        }
                    }, 200);
                } else {
                    throw new Error(`–¢–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏. –û–∂–∏–¥–∞–ª–æ—Å—å: "${newText}", –ü–æ–ª—É—á–µ–Ω–æ: "${updatedBlock.text}"`);
                }
                
            } catch (error) {
                logTest('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –¢–µ—Å—Ç 3: Drag & Drop
        function testDragText() {
            try {
                const activeSlide = app.state.getActiveSlide();
                if (!activeSlide || activeSlide.textBlocks.length === 0) {
                    throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞ –∏–ª–∏ –±–ª–æ–∫–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                }

                const blockId = activeSlide.textBlocks[0].id;
                const originalX = activeSlide.textBlocks[0].x;
                const originalY = activeSlide.textBlocks[0].y;
                const newX = originalX + 10;
                const newY = originalY + 10;

                // –ò–∑–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ StateManager (–∏–º–∏—Ç–∏—Ä—É–µ–º drag)
                const successX = app.state.updateTextBlockProperty(blockId, 'x', newX);
                const successY = app.state.updateTextBlockProperty(blockId, 'y', newY);
                
                if (!successX || !successY) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const updatedSlide = app.state.getActiveSlide();
                const updatedBlock = updatedSlide.textBlocks.find(b => b.id === blockId);
                
                if (updatedBlock.x === newX && updatedBlock.y === newY) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const blockInDOM = document.querySelector(`[data-block-id="${blockId}"]`);
                        if (blockInDOM) {
                            const computedStyle = window.getComputedStyle(blockInDOM);
                            const domLeft = computedStyle.left;
                            const domTop = computedStyle.top;
                            
                            logTest('Drag & Drop', true, `–ü–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞: (${originalX}%, ${originalY}%) ‚Üí (${newX}%, ${newY}%). DOM: left=${domLeft}, top=${domTop}`);
                        } else {
                            logTest('Drag & Drop', false, '–ü–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ –±–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
                        }
                    }, 100);
                } else {
                    throw new Error('–ü–æ–∑–∏—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏');
                }
                
            } catch (error) {
                logTest('Drag & Drop', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –¢–µ—Å—Ç 4: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã
        function testResizeWidth() {
            try {
                const activeSlide = app.state.getActiveSlide();
                if (!activeSlide || activeSlide.textBlocks.length === 0) {
                    throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞ –∏–ª–∏ –±–ª–æ–∫–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞');
                }

                const blockId = activeSlide.textBlocks[0].id;
                const originalWidth = activeSlide.textBlocks[0].width;
                const newWidth = originalWidth + 15;

                // –ò–∑–º–µ–Ω—è–µ–º —à–∏—Ä–∏–Ω—É —á–µ—Ä–µ–∑ StateManager
                const success = app.state.updateTextBlockProperty(blockId, 'width', newWidth);
                
                if (!success) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —à–∏—Ä–∏–Ω—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —à–∏—Ä–∏–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const updatedSlide = app.state.getActiveSlide();
                const updatedBlock = updatedSlide.textBlocks.find(b => b.id === blockId);
                
                if (updatedBlock.width === newWidth) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const blockInDOM = document.querySelector(`[data-block-id="${blockId}"]`);
                        if (blockInDOM) {
                            const computedStyle = window.getComputedStyle(blockInDOM);
                            const domWidth = computedStyle.width;
                            
                            logTest('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã', true, `–®–∏—Ä–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: ${originalWidth}% ‚Üí ${newWidth}%. DOM width: ${domWidth}`);
                        } else {
                            logTest('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã', false, '–®–∏—Ä–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ –±–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
                        }
                    }, 100);
                } else {
                    throw new Error('–®–∏—Ä–∏–Ω–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏');
                }
                
            } catch (error) {
                logTest('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –¢–µ—Å—Ç 5: –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function testStateConsistency() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã StateManager —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                const slidesCount = app.state.getSlidesCount();
                const allSlides = app.state.getAllSlides();
                const activeSlide = app.state.getActiveSlide();
                const activeSlideIndex = app.state.getActiveSlideIndex();

                let issues = [];

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤
                if (slidesCount !== allSlides.length) {
                    issues.push(`–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–ª–∞–π–¥–æ–≤: getSlidesCount()=${slidesCount}, getAllSlides().length=${allSlides.length}`);
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ê–∫—Ç–∏–≤–Ω—ã–π —Å–ª–∞–π–¥
                if (!activeSlide) {
                    issues.push('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞');
                } else {
                    const slideById = app.state.getSlideById(activeSlide.id);
                    if (!slideById) {
                        issues.push('–ê–∫—Ç–∏–≤–Ω—ã–π —Å–ª–∞–π–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ getSlideById()');
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ò–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞
                if (activeSlideIndex < 0 || activeSlideIndex >= slidesCount) {
                    issues.push(`–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞: ${activeSlideIndex} (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0-${slidesCount-1})`);
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–ø–∏–π (–Ω–µ –¥–æ–ª–∂–Ω—ã –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª)
                if (activeSlide) {
                    const originalBlocksCount = activeSlide.textBlocks.length;
                    activeSlide.textBlocks.push({ test: 'mutation' }); // –ü–æ–ø—ã—Ç–∫–∞ –º—É—Ç–∞—Ü–∏–∏
                    
                    const freshActiveSlide = app.state.getActiveSlide();
                    if (freshActiveSlide.textBlocks.length !== originalBlocksCount) {
                        issues.push('–ù–∞—Ä—É—à–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–ø–∏–π - –≤–Ω–µ—à–Ω—è—è –º—É—Ç–∞—Ü–∏—è –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                    }
                }

                if (issues.length === 0) {
                    logTest('–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è', true, `–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã. –°–ª–∞–π–¥–æ–≤: ${slidesCount}, –∞–∫—Ç–∏–≤–Ω—ã–π: ${activeSlideIndex}`);
                } else {
                    logTest('–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è', false, `–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: ${issues.join('; ')}`);
                }
                
            } catch (error) {
                logTest('–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è', false, `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        function runAllTests() {
            document.getElementById('testResults').innerHTML = '<div class="test-info">üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...</div>';
            
            setTimeout(() => testAddTextBlock(), 100);
            setTimeout(() => testEditText(), 300);
            setTimeout(() => testDragText(), 500);
            setTimeout(() => testResizeWidth(), 700);
            setTimeout(() => testStateConsistency(), 900);
            
            setTimeout(() => {
                const successCount = testResults.filter(r => r.success).length;
                const totalCount = testResults.length;
                const resultsDiv = document.getElementById('testResults');
                
                resultsDiv.innerHTML += `
                    <div class="test-status ${successCount === totalCount ? 'test-success' : 'test-error'}">
                        üìä –ò—Ç–æ–≥–æ: ${successCount}/${totalCount} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ
                    </div>
                `;
            }, 1200);
        }

        // –°–±—Ä–æ—Å –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function resetToEditMode() {
            if (app) {
                app.enterEditMode();
                logTest('–°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞', true, '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                setTimeout(() => {
                    initTestApp();
                }, 1000);
            }, 500);
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            logTest('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞', false, event.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        });
    </script>
</body>
</html>