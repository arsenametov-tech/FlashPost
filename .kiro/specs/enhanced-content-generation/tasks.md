# Implementation Plan: Enhanced Content Generation System

## Overview

Данный план описывает пошаговую реализацию улучшенной системы генерации контента для FlashPost Mini App. Система будет интегрирована с существующим кодом и добавит возможности создания логически связанных каруселей без повторений.

## Tasks

- [ ] 1. Создание базовой архитектуры системы
  - Создать новые классы для Content Planning Engine, Logic Chain Validator, Repetition Detector
  - Определить интерфейсы для взаимодействия между компонентами
  - Настроить структуру данных для расширенных слайдов
  - _Requirements: 3.1, 3.2, 6.1_

- [ ] 2. Реализация Content Planning Engine
  - [ ] 2.1 Создать класс ContentPlanningEngine
    - Реализовать метод createContentPlan() для создания общего плана карусели
    - Добавить логику анализа темы и создания структуры повествования
    - _Requirements: 3.1, 3.2_
  
  - [ ] 2.2 Написать property-тест для Content Planning Engine
    - **Property 4: Structured Content Planning**
    - **Validates: Requirements 3.1, 3.2, 3.4**
  
  - [ ] 2.3 Реализовать валидацию плана
    - Добавить проверку связности плана
    - Реализовать адаптацию плана под тематику
    - _Requirements: 3.4, 8.4_

- [ ] 3. Реализация Logic Chain Validator
  - [ ] 3.1 Создать класс LogicChainValidator
    - Реализовать анализ логических связей между слайдами
    - Добавить оценку силы связей и выявление слабых мест
    - _Requirements: 1.1, 1.2, 1.3_
  
  - [ ] 3.2 Написать property-тест для Logic Chain Validator
    - **Property 1: Logical Chain Coherence**
    - **Validates: Requirements 1.1, 1.2, 1.3**
  
  - [ ] 3.3 Реализовать предложения по улучшению
    - Добавить логику генерации рекомендаций для слабых связей
    - Интегрировать с Content Generator для исправлений
    - _Requirements: 1.1, 1.3_

- [ ] 4. Checkpoint - Проверка базовой архитектуры
  - Убедиться, что все тесты проходят, спросить пользователя при возникновении вопросов.

- [ ] 5. Реализация Repetition Detector
  - [ ] 5.1 Создать класс RepetitionDetector
    - Реализовать анализ повторяющихся фраз и слов
    - Добавить алгоритм определения схожести фраз
    - _Requirements: 2.1, 2.3, 2.4_
  
  - [ ] 5.2 Написать property-тест для Repetition Detector
    - **Property 2: Content Repetition Prevention**
    - **Validates: Requirements 2.1, 2.3, 2.4**
  
  - [ ] 5.3 Реализовать генерацию альтернатив
    - Добавить логику создания альтернативных формулировок
    - Интегрировать с AI системой для генерации синонимов
    - _Requirements: 2.2_
  
  - [ ] 5.4 Написать property-тест для генерации альтернатив
    - **Property 3: Alternative Generation on Repetition**
    - **Validates: Requirements 2.2**

- [ ] 6. Улучшение Content Generator
  - [ ] 6.1 Расширить существующий класс FlashPostApp
    - Добавить поддержку контекстной генерации слайдов
    - Интегрировать с Content Planning Engine
    - _Requirements: 1.2, 3.3_
  
  - [ ] 6.2 Реализовать структурированную генерацию
    - Добавить проверку соответствия структуре Hook-Problem-Cause-Solution-Result-CTA
    - Обеспечить правильное содержание для каждого типа слайда
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [ ] 6.3 Написать property-тест для структуры карусели
    - **Property 6: Carousel Structure Adherence**
    - **Validates: Requirements 4.1, 4.2, 4.3, 4.4, 4.5, 4.6**

- [ ] 7. Реализация Style Consistency Checker
  - [ ] 7.1 Создать класс StyleConsistencyChecker
    - Реализовать анализ стиля и тона контента
    - Добавить проверку соответствия стилистическим требованиям
    - _Requirements: 5.1, 5.2, 5.4_
  
  - [ ] 7.2 Написать property-тест для стилистической консистентности
    - **Property 7: Style Consistency**
    - **Validates: Requirements 5.1, 5.2, 5.4**
  
  - [ ] 7.3 Реализовать адаптацию стиля под тематику
    - Добавить специфические стили для разных тем (AI, криптовалюты, личный бренд)
    - Интегрировать с системой тематической адаптации
    - _Requirements: 8.1, 8.2, 8.3_
  
  - [ ] 7.4 Написать property-тест для тематической адаптации
    - **Property 11: Theme-Specific Adaptation**
    - **Validates: Requirements 8.1, 8.2, 8.3, 8.4**

- [ ] 8. Checkpoint - Проверка основной функциональности
  - Убедиться, что все тесты проходят, спросить пользователя при возникновении вопросов.

- [ ] 9. Интеграция с существующей системой
  - [ ] 9.1 Обновить методы генерации в FlashPostApp
    - Интегрировать новые компоненты в существующий workflow
    - Обеспечить обратную совместимость с текущими функциями
    - _Requirements: 6.1, 6.4_
  
  - [ ] 9.2 Обновить систему кэширования
    - Адаптировать кэш для работы с расширенными данными слайдов
    - Добавить кэширование планов контента
    - _Requirements: 6.2_
  
  - [ ] 9.3 Написать property-тест для системной интеграции
    - **Property 8: System Integration Compatibility**
    - **Validates: Requirements 6.1, 6.2, 6.3, 6.4**

- [ ] 10. Улучшение JSON обработки
  - [ ] 10.1 Расширить структуру JSON вывода
    - Добавить метаданные для логических связей
    - Включить информацию о стилистических характеристиках
    - _Requirements: 7.1, 7.2_
  
  - [ ] 10.2 Обеспечить совместимость структуры данных
    - Проверить совместимость с существующими компонентами FlashPost
    - Добавить миграцию для старых форматов данных
    - _Requirements: 7.3_
  
  - [ ] 10.3 Написать property-тест для JSON корректности
    - **Property 9: JSON Output Correctness**
    - **Validates: Requirements 7.1, 7.2, 7.4**
  
  - [ ] 10.4 Написать property-тест для совместимости данных
    - **Property 10: Data Structure Compatibility**
    - **Validates: Requirements 7.3**

- [ ] 11. Реализация улучшенных промптов для AI
  - [ ] 11.1 Обновить buildAnalysisPrompt()
    - Добавить более детальные инструкции для анализа темы
    - Включить требования к логической структуре
    - _Requirements: 3.1, 1.1_
  
  - [ ] 11.2 Обновить buildCarouselPrompt()
    - Добавить инструкции по предотвращению повторений
    - Включить требования к стилистической консистентности
    - _Requirements: 2.1, 5.1, 5.2_
  
  - [ ] 11.3 Реализовать контекстные промпты
    - Добавить передачу контекста предыдущих слайдов в промпты
    - Обеспечить учет плана контента при генерации
    - _Requirements: 1.2, 3.3_

- [ ] 12. Обработка ошибок и fallback механизмы
  - [ ] 12.1 Улучшить обработку ошибок AI
    - Добавить специфическую обработку ошибок логической связности
    - Реализовать fallback для случаев обнаружения повторений
    - _Requirements: 6.3, 2.2_
  
  - [ ] 12.2 Реализовать качественные fallback шаблоны
    - Создать локальные шаблоны с учетом новых требований
    - Обеспечить логическую связность в fallback контенте
    - _Requirements: 6.3, 1.1_

- [ ] 13. Финальное тестирование и интеграция
  - [ ] 13.1 Провести интеграционное тестирование
    - Протестировать полный цикл генерации с новой системой
    - Проверить совместимость со всеми существующими функциями
    - _Requirements: 6.1, 6.4_
  
  - [ ] 13.2 Написать property-тест для структуры слайдов
    - **Property 5: Slide Structure Compliance**
    - **Validates: Requirements 3.3, 5.3**
  
  - [ ] 13.3 Провести тестирование производительности
    - Измерить время генерации с новыми компонентами
    - Оптимизировать узкие места в производительности
    - _Requirements: 6.1_

- [-] 14. Реализация визуального редактора слайдов
  - [ ] 14.1 Создать систему стилизации слайдов
    - Реализовать поддержку фоновых изображений с настройками яркости и позиции
    - Добавить систему текстовых блоков с полным контролем стиля
    - _Requirements: 7.2, 7.3_
  
  - [ ] 14.2 Реализовать редактор текстовых блоков
    - Добавить поддержку множественных текстовых блоков на слайде
    - Реализовать настройки шрифта, размера, веса, цвета и эффектов
    - Добавить систему позиционирования и изменения размеров
    - _Requirements: 5.1, 5.2_
  
  - [ ] 14.3 Создать систему ключевых слов
    - Реализовать автоматическое выделение ключевых слов
    - Добавить специальные стили для важных терминов
    - _Requirements: 8.1, 8.2, 8.3_
  
  - [ ] 14.4 Реализовать функцию "Применить ко всем"
    - Добавить возможность применения стилей ко всем слайдам карусели
    - Обеспечить сохранение индивидуальных настроек при необходимости
    - _Requirements: 6.1, 7.3_
  
  - [ ] 14.5 Интегрировать с JSON структурой
    - Обновить JSON схему для поддержки визуальных настроек
    - Обеспечить совместимость с существующей системой экспорта
    - _Requirements: 7.1, 7.2, 7.4_

- [ ] 15. Финальный checkpoint - Убедиться, что все тесты проходят
  - Убедиться, что все тесты проходят, спросить пользователя при возникновении вопросов.

## Notes

- Все задачи являются обязательными для комплексной реализации системы
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoint'ы обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и граничные случаи
- Система построена на основе существующего кода FlashPost для максимальной совместимости

## Дополнительные требования к системе проверки повторений

На основе обратной связи пользователя, система проверки повторений должна работать следующим образом:

### Алгоритм проверки повторений:
1. **Парсинг JSON** - извлечение текста из всех слайдов
2. **Анализ повторений** - поиск одинаковых слов/фраз между слайдами
3. **Условная регенерация** - если обнаружены повторы → повторный запрос к AI
4. **Исправляющий промпт** - специальный промпт для устранения повторений

### Исправляющий промпт:
```
В предыдущем ответе есть повторы формулировок между слайдами. 
Перепиши тексты так, чтобы формулировки отличались, но смысл сохранялся. 
Верни только JSON.
```

### Критерии повторений:
- **Точные совпадения** - одинаковые фразы из 3+ слов
- **Начальные слова** - повторение первых слов предложений
- **Ключевые термины** - избыточное использование одних и тех же терминов
- **Структурные повторы** - одинаковые конструкции предложений

Эта логика должна быть реализована в задачах 5.1-5.4 (Repetition Detector) и интегрирована в общий процесс генерации контента.